
Aplicacion.Clientes=function(){return this._init();};Aplicacion.Clientes.prototype._init=function(){if(DEBUG){console.log("ApplicacionClientes: construyendo");}
this.listaDeClientesLoad();this.listaDeClientesPanelCreator();this.detallesDeClientesPanelCreator();this.nuevoClientePanelCreator();this.detallesDeVentaPanelCreator();this.finishedPanelCreator();this.finishedPanelCreatorReimpresionTicket();this.facturaPanelCreator();Aplicacion.Clientes.currentInstance=this;return this;};Aplicacion.Clientes.prototype.getConfig=function(){if(POS.U.g===null){window.location="sucursal.html";}
return POS.U.g?{text:'Clientes',cls:'launchscreen',card:this.listaDeClientesPanel,items:[{text:'Nuevo Cliente',card:this.nuevoClientePanel,leaf:true},{text:'Lista de Clientes',card:this.listaDeClientesPanel,leaf:true}]}:{text:'Clientes',cls:'launchscreen',card:this.listaDeClientesPanel,leaf:true};};Aplicacion.Clientes.prototype.listaDeCompras={lista:null,compraActual:null};Aplicacion.Clientes.prototype.listaDeComprasClienteLoad=function(id_cliente){if(DEBUG){console.log("Actualizando lista de compras del cliente "+id_cliente);}
Aplicacion.Clientes.CLIENTE_SELECCIONADO=id_cliente;Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:309,id_cliente:id_cliente},success:function(response,opts){try{compras=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
if(!compras.success){return this.listaDeComprasClienteLoad(id_cliente);}
this.listaDeCompras.lista=compras.datos;if(DEBUG){console.log("cargando la nueva lista mejorada ajax : ",this.listaDeCompras.lista);}
Aplicacion.Clientes.currentInstance.detallesDeClientesPanelShow(id_cliente);Aplicacion.Clientes.currentInstance.creditoDeClientesPanelUpdater(id_cliente);}});};Ext.regModel('listaDeClientesModel',{fields:[{name:'nombre',type:'string'}]});Aplicacion.Clientes.prototype.listaDeClientes={lista:null,lastUpdate:null,hash:null};var dan;Aplicacion.Clientes.prototype.listaDeClientesLoad=function(){if(DEBUG){console.log("Actualizando lista de clientes ....");}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:300},success:function(response,opts){try{clientes=Ext.util.JSON.decode(response.responseText);raw_clientes=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
if(!clientes.success){return this.listaDeClientesLoad();}
this.listaDeClientes.lista=clientes.datos;this.listaDeClientes.lastUpdate=Math.round(new Date().getTime()/1000.0);this.listaDeClientes.hash=clientes.hash;this.listaDeClientesStore.loadData(clientes.datos);if(Aplicacion.Mostrador&&(Aplicacion.Mostrador.currentInstance.buscarClienteForm.getComponent(0).getStore()===null)){if(DEBUG){console.log("Mostrador existe ya y no tiene el store, se lo cargare dese clientes...");}
Aplicacion.Mostrador.currentInstance.buscarClienteForm.getComponent(0).store=this.listaDeClientesStore;}}});};Aplicacion.Clientes.prototype.listaDeClientesStore=new Ext.data.Store({model:'listaDeClientesModel',sorters:'razon_social',getGroupString:function(record){if(record.get('razon_social')===undefined||record.get('razon_social')===null){return"#";}else{var fName=record.get('razon_social')[0];if(fName===undefined){return"#";}else{return fName.toUpperCase();}}}});Aplicacion.Clientes.prototype.listaDeClientesPanel=null;Aplicacion.Clientes.CLIENTE_SELECCIONADO=null;Aplicacion.Clientes.prototype.listaDeClientesPanelCreator=function(){this.listaDeClientesPanel=new Ext.Panel({layout:'fit',items:[{xtype:'list',store:this.listaDeClientesStore,itemTpl:'<div class="listaDeClientesCliente" onClick = "Aplicacion.Clientes.currentInstance.listaDeComprasClienteLoad( {id_cliente} )" ><strong>{razon_social}</strong> {rfc}</div>',grouped:true,indexBar:true,listeners:{"beforerender":function(a,b,c){if(DEBUG)console.log("beforerender lista de clientes panel creator:",a,b,c);},show:function(a,b,c){if(DEBUG)console.log("show lista de clicentes",a,b,c);}}}]});};Aplicacion.Clientes.prototype.detallesDeVentaPanel=null;Aplicacion.Clientes.prototype.detallesDeVentaPanelShow=function(venta){if(this.detallesDeVentaPanel){this.detallesDeVentaPanelUpdater(venta);}else{this.detallesDeVentaPanelCreator();this.detallesDeVentaPanelUpdater(venta);}
this.detallesDeVentaPanel.setCentered(true);this.detallesDeVentaPanel.show(Ext.anims.fade);if(Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual.factura!=null){Ext.getCmp('facturar-venta-button').hide();Ext.getCmp('reimprimir-factura-button').show();}else{Ext.getCmp('facturar-venta-button').show();Ext.getCmp('reimprimir-factura-button').hide();}};Aplicacion.Clientes.prototype.detallesDeVentaPanelUpdater=function(venta)
{ventas=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;var detalleVenta;for(var i=ventas.length-1;i>=0;i--){if(ventas[i].id_venta==venta){detalleVenta=ventas[i].detalle_venta;Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual=ventas[i];break;}}
var factura=null;if(ventas[i].factura!=null){factura=true;}else{factura=false;}
var html="";html+="<table border = '0' align = 'center' style = 'font-weight:bold; font-size:13px; !important;'>";html+="<tr class='top' align = 'center'>";html+="<td align = 'center'>Producto</td>";html+="<td align = 'center'>Descripcion</td>";html+="<td align = 'center'>Cantidad Original Entregada</td>";html+="<td align = 'center'>Descuento</td>";html+="<td align = 'center'>Cantidad Original Cobrada</td>";html+="<td align = 'center'>Precio</td>";html+="<td align = 'center'>Cantidad procesada</td>";html+="<td align = 'center'>Precio procesada</td>";html+="<td>Importe</td>";html+="</tr>";var i;for(i=0;i<detalleVenta.length;i++){html+="<tr align = 'center'>";if(DEBUG){console.log("El detalle de la venta consiste en : ",detalleVenta[i]);}
detalleVenta[i].descuento=detalleVenta[i].descuento!=null?detalleVenta[i].descuento:0;html+="<td>"+detalleVenta[i].id_producto+"</td>";html+="<td>"+detalleVenta[i].descripcion+"</td>";html+="<td>"+(parseFloat(detalleVenta[i].cantidad)+parseFloat(detalleVenta[i].descuento))+"</td>";html+="<td style = '"+(detalleVenta[i].descuento>0?"color:red":"")+"'>"+detalleVenta[i].descuento+"</td>";html+="<td>"+detalleVenta[i].cantidad+"</td>";html+="<td>"+POS.currencyFormat(detalleVenta[i].precio)+"</td>";html+="<td>"+detalleVenta[i].cantidad_procesada+"</td>";html+="<td>"+POS.currencyFormat(detalleVenta[i].precio_procesada)+"</td>";var subtotal=parseFloat(detalleVenta[i].precio)*parseFloat(detalleVenta[i].cantidad);var subtotal_procesada=parseFloat(detalleVenta[i].precio_procesada)*parseFloat(detalleVenta[i].cantidad_procesada);subtotal=subtotal+subtotal_procesada;html+="<td>"+POS.currencyFormat(subtotal)+"</td>";html+="</tr>";}
html+="<tr class='last' align = 'center'>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<tr class='last' align = 'center' >";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td><b>Subtotal : </b></td>";html+="<td><b>"+POS.currencyFormat(Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual.subtotal)+"</b></td>";html+="<tr class='last' align = 'center'>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td><b>Descuento : </b></td>";html+="<td align = 'right'><b>- "+Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual.descuento+"%</b></td>";html+="<tr class='last' align = 'center'>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td></td>";html+="<td><b>Total : </b></td>";html+="<td style = 'color:red;'><b>"+POS.currencyFormat(Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual.total)+"</b></td>";html+="</table>";this.detallesDeVentaPanel.update(html);this.detallesDeVentaPanel.setWidth(900);this.detallesDeVentaPanel.setHeight(400);return factura;};Aplicacion.Clientes.prototype.detallesDeVentaPanelCreator=function()
{venta=[{text:'Regresar',ui:'back',handler:function(t){Aplicacion.Clientes.currentInstance.detallesDeVentaPanel.hide(Ext.anims.fade);}},{xtype:'spacer'},{text:'Imprimir Ticket',ui:'normal',handler:function(){if(DEBUG){console.log("venta actual es : ",Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual);}
Aplicacion.Clientes.currentInstance.detallesDeVentaPanel.hide(Ext.anims.fade);Aplicacion.Clientes.currentInstance.finishedPanelShowReimpresionTicket(Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual);}},{xtype:'spacer'},{text:'Facturar Venta',id:'facturar-venta-button',ui:'forward',handler:function(){if(DEBUG){console.log("Facturando la venta : ",Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual);}
sink.Main.ui.setActiveItem(Aplicacion.Clientes.currentInstance.FacturaPanel,'fade');var compra=Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual;Ext.getCmp('facturaPanel-id_venta').setValue(compra.id_venta);Ext.getCmp('facturaPanel-fecha').setValue(compra.fecha);Ext.getCmp('facturaPanel-cajero').setValue(compra.cajero);Ext.getCmp('facturaPanel-razon_social').setValue(compra.razon_social);Ext.getCmp('facturaPanel-tipo_venta').setValue(compra.tipo_venta);Ext.getCmp('facturaPanel-total').setValue(POS.currencyFormat(compra.total));Ext.getCmp('facturaPanel-pagado').setValue(POS.currencyFormat(compra.pagado));Ext.getCmp('facturaPanel-sucursal').setValue(compra.sucursal);Ext.getCmp('facturaPanel-Concepto').setValue("")
if(compra.pagado<compra.total){Ext.get('action-facturar-venta').hide(Ext.anims.fade);}else{Ext.get('action-facturar-venta').show(Ext.anims.fade);}
Aplicacion.Clientes.currentInstance.detallesDeVentaPanel.hide(Ext.anims.fade);}},{text:'Reimprimir Factura',id:'reimprimir-factura-button',ui:'forward',handler:function(){if(DEBUG){console.log("Facturando la venta : ",Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual);}
Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.setActiveItem(3)
Aplicacion.Clientes.currentInstance.detallesDeVentaPanel.hide(Ext.anims.fade);}}];dockedItems=[new Ext.Toolbar({ui:'dark',dock:'bottom',items:venta})];this.detallesDeVentaPanel=new Ext.Panel({floating:true,ui:"dark",modal:true,showAnimation:Ext.anims.fade,centered:true,hideOnMaskTap:true,cls:"Tabla",bodyPadding:0,bodyMargin:0,styleHtmlContent:false,html:null,scroll:'none',dockedItems:dockedItems});};Aplicacion.Clientes.prototype.detallesDeClientesPanel=null;Aplicacion.Clientes.prototype.detallesDeClientesPanelShow=function(id_cliente){if(DEBUG){console.log("mostrando detalles",id_cliente);}
if(this.detallesDeClientesPanel){this.detallesDeClientesPanelUpdater(id_cliente);}else{this.detallesDeClientesPanelCreator();this.detallesDeClientesPanelUpdater(id_cliente);}
if(id_cliente<=0){Ext.getCmp("Clientes-EditarDetalles").setVisible(false);Ext.getCmp("Clientes-Estado-Cuenta").setVisible(false);}
else{Ext.getCmp("Clientes-EditarDetalles").setVisible(true);Ext.getCmp("Clientes-Estado-Cuenta").setVisible(true);}
sink.Main.ui.setActiveItem(this.detallesDeClientesPanel,'slide');Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.setActiveItem(0);};Aplicacion.Clientes.prototype.detallesDeClientesPanelUpdater=function(id_cliente)
{if(DEBUG){console.log("Detalles del Cliente : ",id_cliente);}
var listaClientes=Aplicacion.Clientes.currentInstance.listaDeClientes.lista;var record=null;for(var i=0;i<listaClientes.length;i++){if(listaClientes[i].data.id_cliente==id_cliente){record=listaClientes[i];}}
var detallesPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0];detallesPanel.loadRecord(record);Aplicacion.Clientes.currentInstance.comprasDeClientesPanelUpdater(id_cliente);Aplicacion.Clientes.currentInstance.facturasDeClientesPanelUpdater();};Aplicacion.Clientes.prototype.comprasDeClientesPanelUpdater=function(id_cliente)
{var comprasPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(1);if(DEBUG){console.log("leyendo la lista mejorada : ",this.listaDeCompras.lista);}
var lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;var html="";html+="<table border=0>";html+="<tr class='top'>";html+="<td>ID</td>";html+="<td>Fecha</td>";html+="<td>Sucursal</td>";html+="<td>Tipo</td>";html+="<td>Total</td>";html+="<td>Saldo</td>";html+="</tr>";var saldo=null;var style=null;for(var i=lista.length-1;i>=0;i--){if(lista[i].id_cliente!=id_cliente){continue;}
if(i===0)
html+="<tr class='last' onClick='Aplicacion.Clientes.currentInstance.detallesDeVentaPanelShow("+lista[i].id_venta+");'>";else
html+="<tr onClick='Aplicacion.Clientes.currentInstance.detallesDeVentaPanelShow("+lista[i].id_venta+");'>";html+="<td>"+lista[i].id_venta+"</td>";var fecha=POS.fecha(lista[i].fecha);html+="<td>"+fecha+"</td>";html+="<td>"+lista[i].sucursal+"</td>";html+="<td>"+lista[i].tipo_venta+"</td>";html+="<td>"+POS.currencyFormat(lista[i].total)+"</td>";saldo=lista[i].total-lista[i].pagado;if(saldo>0)
{style="style = 'color:red'"}
html+="<td "+style+" >"+POS.currencyFormat(saldo)+"</td>";html+="</tr>";style=null;}
html+="</table>";comprasPanel.update(html);};Aplicacion.Clientes.prototype.facturasDeClientesPanelUpdater=function()
{if(DEBUG){console.log("leyendo la lista mejorada : ",this.listaDeCompras.lista);}
var facturasPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(3);var lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;var html="";html+="<table border=0 align = 'center'>";html+="<tr class='top' align = 'center'>";html+="<td>ID Folio</td>";html+="<td>ID Venta</td>";html+="<td>Fecha Timbrado</td>";html+="<td>Lugar de Emision</td>";html+="<td>Facturo</td>";html+="<td>Reimprimir</td>";html+="</tr>";for(var i=lista.length-1;i>=0;i--){if(lista[i].factura==null){continue;}
for(var j=0;j<lista[i].factura.length;j++){html+="<tr align = 'center'>";html+="<td>"+lista[i].factura[j].id_folio+"</td>";html+="<td>"+lista[i].id_venta+"</td>";html+="<td>"+POS.fecha(lista[i].factura[j].fecha_certificacion)+"</td>";html+="<td>"+lista[i].factura[j].lugar_emision+"</td>";html+="<td>"+lista[i].factura[j].usuario+"</td>";html+="<td><img src = '../media/icons/page_text_32.png' onClick = 'window.open(\"http://development.pos.caffeina.mx/proxy.php?action=1308&id_venta="+lista[i].id_venta+"\")'></td>";html+="</tr>";}}
html+="</table>";facturasPanel.update(html);};Aplicacion.Clientes.prototype.editarClienteCancelarBoton=function()
{var detallesPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0];var cliente=Aplicacion.Clientes.currentInstance.CLIENTE_EDIT;Aplicacion.Clientes.currentInstance.CLIENTE_EDIT=null;if(DEBUG){console.log("cancelando: ",cliente);}
detallesPanel.loadRecord(cliente);detallesPanel.disable();detallesPanel.items.items[0].setInstructions("Todos los campos son obligatorios. Serciorese de que todos los campos sean correctos.");Ext.getCmp("Clientes-EditarDetalles").setVisible(true);Ext.getCmp("Clientes-Estado-Cuenta").setVisible(true);Ext.getCmp("Clientes-EditarDetallesGuardar").setVisible(false);Ext.getCmp("Clientes-EditarDetallesCancelar").setVisible(false);Ext.getCmp("Clientes-credito-restante").show(Ext.anims.slide);Ext.getCmp("DetallesCliente_limite_credito").show(Ext.anims.slide);};Aplicacion.Clientes.prototype.editarCliente=function(data)
{if(DEBUG){console.log("Guardando cliente",data);}
Ext.getBody().mask('Guardando...','x-mask-loading',true);Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:302,data:Ext.util.JSON.encode(data)},success:function(response,opts){try{r=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
Ext.getBody().unmask();if(!r.success){Ext.Msg.alert("Editar cliente",r.reason);Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0].items.items[0].setInstructions(r.reason);return;}
var detallesPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0];detallesPanel.disable();Ext.getCmp("Clientes-EditarDetalles").setVisible(true);Ext.getCmp("Clientes-Estado-Cuenta").setVisible(true);Ext.getCmp("Clientes-EditarDetallesGuardar").setVisible(false);Ext.getCmp("Clientes-EditarDetallesCancelar").setVisible(false);Ext.getCmp("Clientes-credito-restante").show(Ext.anims.slide);Ext.getCmp("DetallesCliente_limite_credito").show(Ext.anims.slide);Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0].items.items[0].setInstructions("Sus cambios se han guardado satisfactoriamente.");Aplicacion.Clientes.currentInstance.listaDeClientesLoad();}});};Aplicacion.Clientes.prototype.editarClienteGuardarBoton=function()
{var detallesPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0];v=detallesPanel.getValues();campo=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0].items.items[0];if(v.razon_social.length<10){Ext.Msg.alert("Nuevo cliente","La Razon Social del cliente debe ser mayor de diez caracteres.");return campo.setInstructions("La Razon Social del cliente debe ser mayor de diez caracteres.");}
if(v.rfc.length<10){Ext.Msg.alert("Nuevo cliente","El RFC debe ser mayor de diez caracteres.");return campo.setInstructions("El RFC debe ser mayor de diez caracteres.");}
if(v.calle.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion de la calle es muy corta.");return campo.setInstructions("La descripcion de la calle es muy corta.");}
if(v.numero_exterior.length==0){Ext.Msg.alert("Nuevo cliente","Indique el numero exterior.");return campo.setInstructions("Indique el numero exterior.");}
if(v.colonia.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion de la colonia es muy corta.");return campo.setInstructions("La descripcion de la colonia es muy corta.");}
if(v.municipio.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del municipio es muy corta.");return campo.setInstructions("La descripcion del municipio es muy corta.");}
if(v.estado.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del estado es muy corta.");return campo.setInstructions("La descripcion del estado es muy corta.");}
if(v.pais.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del pais es muy corta.");return campo.setInstructions("La descripcion del pais es muy corta.");}
if(v.codigo_postal.length<5||isNaN(v.codigo_postal)){Ext.Msg.alert("Nuevo cliente","La descripcion del codigo postal es muy corta.");return campo.setInstructions("La descripcion del codigo postal es muy corta.");}
if(v.telefono.length<5){Ext.Msg.alert("Nuevo cliente","La descripcion del telefono es muy corta.");return campo.setInstructions("La descripcion del telefono es muy corta.");}
if(v.descuento.length===0||isNaN(v.descuento)||(v.descuento>50&&v.descuento<0)){Ext.Msg.alert("Nuevo cliente","El descuento debe ser un numero entre 0 y 50.");return campo.setInstructions("El descuento debe ser un numero entre 0 y 50.");}
Aplicacion.Clientes.currentInstance.editarCliente(v);};Aplicacion.Clientes.prototype.CLIENTE_EDIT=null;Aplicacion.Clientes.prototype.editarClienteBoton=function()
{var detallesPanel=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0];Aplicacion.Clientes.currentInstance.CLIENTE_EDIT=detallesPanel.getRecord();detallesPanel.enable();Ext.getCmp("Clientes-EditarDetalles").hide(Ext.anims.slide);Ext.getCmp("Clientes-Estado-Cuenta").hide(Ext.anims.slide);Ext.getCmp("Clientes-EditarDetallesGuardar").show(Ext.anims.slide);Ext.getCmp("Clientes-EditarDetallesCancelar").show(Ext.anims.slide);Ext.getCmp("Clientes-credito-restante").hide(Ext.anims.slide);Ext.getCmp("DetallesCliente_limite_credito").hide(Ext.anims.slide);};Aplicacion.Clientes.prototype.doAbonarValidator=function()
{var monto=Ext.getCmp('Cliente-abonarMonto').getValue();if(!(monto&&/^\d+(\.\d+)?$/.test(monto+''))){Ext.Anim.run(Ext.getCmp('Cliente-abonarMonto'),'fade',{duration:250,out:true,autoClear:true});return;}
var detalleVenta=Aplicacion.Clientes.currentInstance.detalleVentaCredito;var transaccion={abono:null,cambio:null,abonado:detalleVenta.pagado,saldo:detalleVenta.total-detalleVenta.pagado}
if(monto>transaccion.saldo)
{transaccion.abono=transaccion.saldo;transaccion.cambio=monto-transaccion.saldo;transaccion.abonado=transaccion.abonado+transaccion.abono;}
else
{transaccion.abono=monto;transaccion.cambio=0;transaccion.saldo=transaccion.saldo-monto;transaccion.abonado=(parseFloat(transaccion.abonado)+parseFloat(monto));}
Aplicacion.Clientes.currentInstance.doAbonar(transaccion);}
Aplicacion.Clientes.prototype.doAbonar=function(transaccion)
{if(DEBUG){console.log("Abonando... a venta : "+Ext.getCmp("Clentes-CreditoVentasLista").getValue());}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:305,data:Ext.util.JSON.encode({id_venta:parseFloat(Ext.getCmp("Clentes-CreditoVentasLista").getValue()),monto:parseFloat(transaccion.abono),tipo_pago:Ext.getCmp('Clentes-abonarTipoPago').getValue()})},success:function(response,opts){try{r=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
if(!r.success){Ext.Msg.alert("Error",r.reason);return;}
lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;var venta=null;for(var i=lista.length-1;i>=0;i--){if(lista[i].id_venta==Ext.getCmp("Clentes-CreditoVentasLista").getValue()){venta=lista[i];}}
venta.pagado=transaccion.abonado;Aplicacion.Clientes.currentInstance.creditoDeClientesOptionChange("",Ext.getCmp("Clentes-CreditoVentasLista").getValue());for(i=0;i<POS.documentos.length;i++){if(POS.documentos[i].documento=='abono_venta_cliente'){var impresora=POS.documentos[i].impresora;break;}}
var clientes=Aplicacion.Clientes.currentInstance.listaDeClientes.lista;var nombre="";for(var i=clientes.length-1;i>=0;i--)
{if(clientes[i].data.id_cliente==Aplicacion.Clientes.CLIENTE_SELECCIONADO){nombre=clientes[i].data.razon_social;break;}};var data_abono={ticket:'abono_venta_cliente',nombre:nombre,id_venta:Ext.getCmp("Clentes-CreditoVentasLista").getValue(),empleado:r.empleado,saldo_prestamo:transaccion.saldo,monto_abono:transaccion.abono,sucursal:POS.infoSucursal,impresora:impresora,leyendasTicket:POS.leyendasTicket};Aplicacion.Clientes.currentInstance.finishedPanelShow(data_abono);},failure:function(response){return POS.error(response);}});};Aplicacion.Clientes.prototype.abonarVentaBoton=function()
{if(DEBUG){console.log("abonando");}
Ext.getCmp("Clientes-DetallesVentaAbonarCredito").show();Ext.getCmp("Clientes-DetallesVentaCredito").hide();Ext.getCmp("Clientes-AbonarVentaBotonCancelar").show();Ext.getCmp("Clientes-AbonarVentaBotonAceptar").show();Ext.getCmp("Clientes-AbonarVentaBoton").hide();Ext.getCmp("Clientes-SeleccionVentaCredito").hide();Ext.getCmp('Clientes-DetallesVentaAbonarCredito-saldo').setValue(POS.currencyFormat(Aplicacion.Clientes.currentInstance.detalleVentaCredito.total-Aplicacion.Clientes.currentInstance.detalleVentaCredito.pagado));Ext.getCmp('Cliente-abonarMonto').setValue("");};Aplicacion.Clientes.prototype.abonarVentaCancelarBoton=function()
{Ext.getCmp("Clientes-DetallesVentaAbonarCredito").hide();Ext.getCmp("Clientes-DetallesVentaCredito").show();Ext.getCmp("Clientes-AbonarVentaBotonCancelar").hide();Ext.getCmp("Clientes-AbonarVentaBotonAceptar").hide();var detalleVenta=Aplicacion.Clientes.currentInstance.detalleVentaCredito;if((detalleVenta.total-detalleVenta.pagado)>0)
{Ext.getCmp("Clientes-AbonarVentaBoton").show();}
else
{Ext.getCmp("Clientes-AbonarVentaBoton").hide();}
Ext.getCmp("Clientes-SeleccionVentaCredito").show();};Aplicacion.Clientes.prototype.detalleVentaCredito=null;Aplicacion.Clientes.prototype.creditoDeClientesOptionChange=function(a,v)
{if(v==-1){Ext.getCmp("Clientes-DetallesVentaCredito").hide();Ext.getCmp("Clientes-AbonarVentaBoton").hide();return;}
lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;var venta=null;for(var i=lista.length-1;i>=0;i--){if(lista[i].id_venta==v){venta=lista[i];}}
Ext.getCmp("Clientes-DetallesVentaCredito").getComponent(0).setValue(venta.sucursal);Ext.getCmp("Clientes-DetallesVentaCredito").getComponent(1).setValue(venta.cajero);Ext.getCmp("Clientes-DetallesVentaCredito").getComponent(2).setValue(POS.currencyFormat(venta.total));Ext.getCmp("Clientes-DetallesVentaCredito").getComponent(3).setValue(POS.currencyFormat(venta.pagado));Ext.getCmp("Clientes-DetallesVentaCredito").getComponent(4).setValue(POS.currencyFormat(venta.total-venta.pagado));Aplicacion.Clientes.currentInstance.detalleVentaCredito=venta;Ext.getCmp("Clientes-DetallesVentaCredito").show();if((venta.total-venta.pagado)>0)
{Ext.getCmp("Clientes-AbonarVentaBoton").show();}
else
{Ext.getCmp("Clientes-AbonarVentaBoton").hide();}};Aplicacion.Clientes.prototype.creditoDeClientesPanelUpdater=function(id_cliente)
{lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;ventasCredito=[{text:"Seleccione una venta a credito de la lista",value:-1}];for(var i=lista.length-1;i>=0;i--){if(lista[i].id_cliente==id_cliente&&lista[i].tipo_venta=="credito"){if(parseFloat(lista[i].total)!=parseFloat(lista[i].pagado)){ventasCredito.push({text:"Venta "+lista[i].id_venta+" ( "+lista[i].fecha+" ) ",value:lista[i].id_venta});}}}
Ext.getCmp("Clientes-DetallesVentaCredito").hide();Ext.getCmp("Clientes-AbonarVentaBoton").hide();if(DEBUG){console.log('este cliente tiene '+ventasCredito.length+' ventas a credito');}
if(ventasCredito.length==1){Ext.getCmp("Clentes-CreditoVentasLista").hide();Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getTabBar().getComponent(2).hide();}else{Ext.getCmp("Clentes-CreditoVentasLista").show();Ext.getCmp("Clentes-CreditoVentasLista").setOptions(ventasCredito);Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getTabBar().getComponent(2).show();}};Aplicacion.Clientes.prototype.eliminarCliente=function(respuesta)
{if(respuesta!='yes'){return;}
cliente=Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0].getRecord().data;if(DEBUG){console.log("Eliminando al cliente",cliente);}
cliente.activo=0;Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:302,data:Ext.util.JSON.encode(cliente)},success:function(response,opts){try{res=Ext.util.JSON.decode(response.responseText);}catch(e){return POS.error(e);}
if(!res.success){Ext.Msg.alert("Mostrador",res.reason);return;}
if(DEBUG){console.log("Eliminado cliente OK",res);}
sink.Main.ui.setActiveItem(Aplicacion.Clientes.currentInstance.listaDeClientesPanel,'fade');}});};Aplicacion.Clientes.prototype.detallesDeClientesPanelCreator=function(){if(DEBUG){console.log("creando panel de detalles de cliente por primera vez");}
opciones=[new Ext.Button({id:'Clientes-Estado-Cuenta-Ticket',ui:'action',text:'Imprimir ticket de cuenta total',handler:function(){var lista=Aplicacion.Clientes.currentInstance.listaDeCompras.lista;ticket="\n\n"+POS.leyendasTicket.cabeceraTicket+"\n";ticket+="R.F.C. "+POS.leyendasTicket.rfc+"\n";ticket+=POS.leyendasTicket.nombreEmpresa+"\n";ticket+=POS.leyendasTicket.direccion+"\n";ticket+="Tel. "+POS.leyendasTicket.telefono+"\n\n";ticket+="======== Estado de cuenta para ========"+"\n";var clientes=Aplicacion.Clientes.currentInstance.listaDeClientes.lista;for(var i=clientes.length-1;i>=0;i--)
{if(clientes[i].data.id_cliente==Aplicacion.Clientes.CLIENTE_SELECCIONADO){ticket+="     "+clientes[i].data.razon_social+"\n";break;}};ticket+="======================================="+"\n";var saldo_total=0;for(var i=lista.length-1;i>=0;i--){if(lista[i].liquidada=="1")continue;if(lista[i].liquidada==true)continue;if(lista[i].tipo_venta=="contado")continue;saldo_total+=parseFloat(lista[i].total)-parseFloat(lista[i].pagado);ticket+="\n\n------------- Venta "+lista[i].id_venta+" -------------"+"\n";ticket+=POS.fecha(lista[i].fecha)+"\n";ticket+=lista[i].sucursal+"\n";ticket+=lista[i].cajero+"\n";ticket+="\n\n";ticket+=POS.fillWithSpaces("PRODUCTO",14,false);ticket+=" ";ticket+=POS.fillWithSpaces("CANT",5,false);ticket+=" ";ticket+=POS.fillWithSpaces("PRECIO",6,false);ticket+=" ";ticket+=POS.fillWithSpaces("IMPORTE",10,false)+"\n";ticket+="-------------------------------------"+"\n";for(var j=lista[i].detalle_venta.length-1;j>=0;j--){var item=lista[i].detalle_venta[j];if(DEBUG){console.log("DETALLE:",item);}
var prods=Aplicacion.Inventario.currentInstance.Inventario.productos;var p=0,found=false;for(p=0;p<prods.length;p++)
{if(parseInt(prods[p].data.productoID)==parseInt(item.id_producto))
{found=true;break;}};if(item.cantidad!=0)
{var qty=item.cantidad;if(found&&prods[p].data.precioPorAgrupacion)
{qty/=parseFloat(prods[p].data.agrupacionTam);}
ticket+=POS.fillWithSpaces(item.descripcion,14,false);ticket+=" ";ticket+=POS.fillWithSpaces(qty,5,false);ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(item.precio),6,false);ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(parseFloat(qty)*parseFloat(item.precio)),10,false)+"\n";}
if(item.cantidad_procesada!=0)
{var qty=item.cantidad_procesada;if(found&&prods[p].data.precioPorAgrupacion)
{qty/=parseFloat(prods[p].data.agrupacionTam);}
ticket+=POS.fillWithSpaces(item.descripcion,14,false)
ticket+=" ";ticket+=POS.fillWithSpaces(qty,5,false)
ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(item.precio_procesada),6,false)
ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(parseFloat(qty)*parseFloat(item.precio_procesada)),10,false)+"\n";}};ticket+="-------------------------------------"+"\n";ticket+="                  Total     "+POS.currencyFormat(lista[i].total)+"\n";ticket+="                  Saldado   "+POS.currencyFormat(lista[i].pagado)+"\n";ticket+="                  -------------------"+"\n";ticket+="                  Pendiente "+POS.currencyFormat((parseFloat(lista[i].total))-parseFloat(lista[i].pagado))+"\n";};ticket+="\n\n";ticket+="==========================================="+"\n";ticket+="      SALDO TOTAL : "+POS.currencyFormat(saldo_total)+"\n";ticket+="==========================================="+"\n\n";ticket+="  "+POS.leyendasTicket.contacto;if(DEBUG){console.log(ticket);}
POS.ajaxToClient({module:"Impresiones",args:{free_text:ticket},success:function(r){if(DEBUG){console.log("ticket printing responded",r);}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});}}),new Ext.Button({id:'Clientes-Estado-Cuenta',ui:'action',text:'Imprimir Estado de Cuenta',handler:function(){window.open("http://pos.caffeina.mx/proxy.php?action=1307&id_cliente="+Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.getComponent(0).items.items[0].getValues().id_cliente);}}),new Ext.Button({id:'Clientes-EditarDetalles',ui:'action',text:'Editar Detalles del Cliente',handler:this.editarClienteBoton}),new Ext.Button({id:'Clientes-EditarDetallesCancelar',ui:'decline',text:'Cancelar',handler:this.editarClienteCancelarBoton,hidden:true}),new Ext.Button({id:'Clientes-EditarDetallesGuardar',ui:'confirm',text:'Guardar',handler:this.editarClienteGuardarBoton,hidden:true})];var dockedItems=[new Ext.Toolbar({ui:'light',dock:'top',items:[{xtype:"spacer"}].concat(opciones)})];detallesDelCliente=new Ext.form.FormPanel({title:'Detalles del Cliente',items:[{xtype:'fieldset',instructions:'Los campos marcados con asterisco son obligatorios.',defaults:{disabled:true},items:[new Ext.form.Text({name:'razon_social',label:'Razon Social',required:true,listeners:{'focus':function(){kconf={type:'alfa',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'id_cliente',label:'ID',hidden:true}),new Ext.form.Text({name:'activo',hidden:true}),new Ext.form.Text({name:'id_usuario',hidden:true}),new Ext.form.Text({name:'id_sucursal',hidden:true}),new Ext.form.Text({name:'rfc',label:'RFC',required:true,listeners:{'focus':function(){kconf={type:'alfanum',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'calle',label:'Calle',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'numero_exterior',label:'Numero Exterior',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'numero_interior',label:'Numero Interior',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'colonia',label:'Colonia',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'referencia',label:'Referencia',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'localidad',label:'Localidad',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'municipio',label:'Municipio',required:true,listeners:{'focus':function(){kconf={type:'alfa',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'estado',label:'Estado',value:'GUANAJUATO',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'pais',label:'Pais',required:true,value:'MEXICO',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'codigo_postal',label:'Codigo Postal',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'telefono',label:'Telefono',required:true,listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'e_mail',label:'E-mail',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'descuento',label:'Descuento',required:false,listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({id:'Clientes-credito-restante',name:'credito_restante',label:'Restante',required:false}),new Ext.form.Text({id:'DetallesCliente_limite_credito',name:'limite_credito',label:'Lim. Credito',required:false,listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}})]}]});abonar=[new Ext.form.FormPanel({items:[{xtype:'fieldset',title:'Abonar una cantidad ',id:'Clientes-Vender',items:[{xtype:'textfield',name:'options',label:"Cantidad",options:[],listeners:{'focus':function(){kconf={type:'num',submitText:'Abonar',callback:function(a,b,c){if(DEBUG){console.log(a);}
Ext.Msg.confirm("Abono por cantidad","&iquest; Esta seguro que desea abonar $"+a.value+" pesos a esta cuenta?",function(res){if(res=="yes"){Aplicacion.Clientes.abonar_por_cantidad(Aplicacion.Clientes.CLIENTE_SELECCIONADO,a.value);}});}};POS.Keyboard.Keyboard(this,kconf);}}}]},{xtype:'fieldset',title:'Abonar a una venta',id:'Clientes-SeleccionVentaCredito',items:[{id:"Clentes-CreditoVentasLista",xtype:'selectfield',name:'options',label:"Venta",options:[],listeners:{"change":function(a,b){Aplicacion.Clientes.currentInstance.creditoDeClientesOptionChange(a,b);}}}]},{xtype:'fieldset',id:'Clientes-DetallesVentaCredito',items:[new Ext.form.Text({name:'sucursal',label:'Sucursal'}),new Ext.form.Text({name:'user_id',label:'Vendedor'}),new Ext.form.Text({name:'total',label:'Total'}),new Ext.form.Text({name:'abonado',label:'Abonado',id:'Clientes-DetallesVentaCredito-abonado'}),new Ext.form.Text({name:'saldo',label:'Saldo',id:'Clientes-DetallesVentaCredito-saldo'})]},{xtype:'fieldset',title:'Detalles del abono',id:'Clientes-DetallesVentaAbonarCredito',hidden:true,items:[new Ext.form.Text({name:'saldo',label:'Saldo',id:'Clientes-DetallesVentaAbonarCredito-saldo'}),{id:"Clentes-abonarTipoPago",xtype:'selectfield',name:'tipo_pago',label:"Tipo de pago",options:[{text:'Efectivo',value:'efectivo'},{text:'Cheque',value:'cheque'}]},new Ext.form.Text({id:'Cliente-abonarMonto',name:'monto',label:'Monto',listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}})]},new Ext.Button({id:'Clientes-AbonarVentaBoton',ui:'action',text:'Abonar',margin:15,handler:this.abonarVentaBoton,hidden:true}),new Ext.Button({id:'Clientes-AbonarVentaBotonAceptar',ui:'action',text:'Abonar',margin:15,handler:this.doAbonarValidator,hidden:true}),new Ext.Button({id:'Clientes-AbonarVentaBotonCancelar',ui:'drastic',text:'Cancelar',margin:15,handler:this.abonarVentaCancelarBoton,hidden:true})]})];this.detallesDeClientesPanel=new Ext.TabPanel({id:'detallesDeClientesPanel',items:[{iconCls:'user',title:'Detalles',scroll:'vertical',dockedItems:POS.U.g?dockedItems:null,items:detallesDelCliente},{iconCls:'bookmarks',title:'Ventas',scroll:'vertical',cls:"Tabla",html:'Lista de compras'},{iconCls:'download',title:'Abonos',items:abonar},{iconCls:'favorites',id:'detallesDeClientesPanel-facturas',title:'Facturas',scroll:'vertical',cls:"Tabla",html:'Lista de Facturas'}],tabBar:{dock:'bottom',layout:{pack:'center'}}});};Aplicacion.Clientes.abonar_por_cantidad=function(id_cliente,monto)
{Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:311,id_cliente:id_cliente,monto:monto},success:function(response,opts){try{res=Ext.util.JSON.decode(response.responseText);}catch(e){return POS.error(e);}
if(!res.success){Ext.Msg.alert("Mostrador",res.reason);return;}
Ext.Msg.alert("Exito","Abono realizado con exito.");Aplicacion.Clientes.currentInstance.detallesDeClientesPanel.setActiveItem(1);}});}
Aplicacion.Clientes.prototype.nuevoClientePanel=null;Aplicacion.Clientes.prototype.nuevoClientePanelShow=function(){if(DEBUG){console.log("mostrando nuevo cliente");}
sink.Main.ui.setActiveItem(this.nuevoClientePanel,'slide');};Aplicacion.Clientes.prototype.nuevoClientePanelCreator=function(){if(DEBUG){console.log("creando panel de nuevo cliente");}
this.nuevoClientePanel=new Ext.form.FormPanel({scroll:'vertical',items:[{xtype:'fieldset',title:'Ingrese los detalles del nuevo cliente',instructions:'Si desea ofrecer un limite de credito que exceda los $20,000.00 debera pedir una autorizacion.',items:[new Ext.form.Text({name:'razon_social',label:'Razon Social',required:true,listeners:{'focus':function(){kconf={type:'alfa',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'rfc',label:'RFC',required:true,listeners:{'focus':function(){kconf={type:'alfanum',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'calle',label:'Calle',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'numero_exterior',label:'Numero Exterior',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'numero_interior',label:'Numero Interior',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'colonia',label:'Colonia',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'referencia',label:'Referencia',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'localidad',label:'Localidad',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'municipio',label:'Municipio',required:true,listeners:{'focus':function(){kconf={type:'alfa',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'estado',label:'Estado',value:'GUANAJUATO',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'pais',label:'Pais',required:true,value:'MEXICO',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'codigo_postal',label:'Codigo Postal',required:true,listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'telefono',label:'Telefono',required:true,listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'e_mail',label:'E-mail',listeners:{'focus':function(){kconf={type:'complete',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'descuento',label:'Descuento',required:false,value:'0',listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'limite_credito',label:'Lim. Credito',value:'0',required:true,listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}})]},new Ext.Button({id:'Clientes-CrearCliente',ui:'action',text:'Crear Cliente',margin:5,handler:this.crearClienteValidator,disabled:false})]});};Aplicacion.Clientes.prototype.crearCliente=function(data)
{Ext.getBody().mask('Creando cliente ...','x-mask-loading',true);Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:301,data:Ext.util.JSON.encode(data)},success:function(response,opts){try{r=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
Ext.getBody().unmask();if(!r.success){Aplicacion.Clientes.currentInstance.nuevoClientePanel.items.items[0].setInstructions(r.reason);return;}
Ext.Msg.alert("Clientes","Se creo correctamente el nuevo cliente")
Aplicacion.Clientes.currentInstance.listaDeClientesLoad();Aplicacion.Clientes.currentInstance.nuevoClientePanel.reset();Aplicacion.Clientes.currentInstance.nuevoClientePanel.items.items[0].setInstructions("Si desea ofrecer un limite de credito que exceda los $20,000.00 debera pedir una autorizacion.");sink.Main.ui.setActiveItem(this.listaDeClientesPanel,'slide');}});};Aplicacion.Clientes.prototype.crearClienteValidator=function()
{v=Aplicacion.Clientes.currentInstance.nuevoClientePanel.getValues();campo=Aplicacion.Clientes.currentInstance.nuevoClientePanel.items.items[0];if(v.razon_social.length<10){Ext.Msg.alert("Nuevo cliente","La Razon Social del cliente debe ser mayor de diez caracteres.");return campo.setInstructions("La Razon Social del cliente debe ser mayor de diez caracteres.");}
if(v.rfc.length<10){Ext.Msg.alert("Nuevo cliente","El RFC debe ser mayor de diez caracteres.");return campo.setInstructions("El RFC debe ser mayor de diez caracteres.");}
if(v.calle.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion de la calle es muy corta.");return campo.setInstructions("La descripcion de la calle es muy corta.");}
if(v.numero_exterior.length==0){Ext.Msg.alert("Nuevo cliente","Indique el numero exterior.");return campo.setInstructions("Indique el numero exterior.");}
if(v.colonia.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion de la colonia es muy corta.");return campo.setInstructions("La descripcion de la colonia es muy corta.");}
if(v.municipio.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del municipio es muy corta.");return campo.setInstructions("La descripcion del municipio es muy corta.");}
if(v.estado.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del estado es muy corta.");return campo.setInstructions("La descripcion del estado es muy corta.");}
if(v.pais.length<3){Ext.Msg.alert("Nuevo cliente","La descripcion del pais es muy corta.");return campo.setInstructions("La descripcion del pais es muy corta.");}
if(v.codigo_postal.length<5||isNaN(v.codigo_postal)){Ext.Msg.alert("Nuevo cliente","La descripcion del codigo postal es muy corta.");return campo.setInstructions("La descripcion del codigo postal es muy corta.");}
if(v.telefono.length<10){Ext.Msg.alert("Nuevo cliente","La descripcion del telefono es muy corta.");return campo.setInstructions("La descripcion del telefono es muy corta.");}
if(v.descuento.length===0||isNaN(v.descuento)||(v.descuento>50&&v.descuento<0)){Ext.Msg.alert("Nuevo cliente","El descuento debe ser un numero entre 0 y 50.");return campo.setInstructions("El descuento debe ser un numero entre 0 y 50.");}
if(v.limite_credito.length===0||isNaN(v.limite_credito)){Ext.Msg.alert("Nuevo cliente","El limite de credito debe ser un numero.");return campo.setInstructions("El limite de credito debe ser un numero.");}
if(v.limite_credito>20000){Ext.Msg.alert("Nuevo cliente","No puede crear un cliente con limite de credito mayor a $20,000. Necesitara pedir una autorizacion.");return campo.setInstructions("No puede crear un cliente con limite de credito mayor a $20,000. Necesitara pedir una autorizacion.");}
Aplicacion.Clientes.currentInstance.crearCliente(v);};Aplicacion.Clientes.prototype.finishedPanel=null;Aplicacion.Clientes.prototype.finishedPanelCreator=function()
{this.finishedPanel=new Ext.Panel({html:""});};Aplicacion.Clientes.prototype.finishedPanelShow=function(data_abono)
{this.finishedPanelUpdater(data_abono);Aplicacion.Clientes.currentInstance.abonarVentaCancelarBoton();action="sink.Main.ui.setActiveItem( Aplicacion.Clientes.currentInstance.detallesDeClientesPanel , 'slide');";setTimeout(action,4000);};Aplicacion.Clientes.prototype.finishedPanelUpdater=function(data_abono)
{if(DEBUG){console.log("se mando a imprimir : ",data_abono);}
POS.ajaxToClient({module:"Printer",args:data_abono,success:function(r){if(DEBUG){console.log("ticket printing responded",r);}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});html="";html+="<table class='Mostrador-ThankYou' style = 'margin : 0 !important;' >";html+=" <tr>";html+="  <td ><img width = 200px height = 200px src='../media/Receipt128.png'></td>";html+=" </tr>";html+=" <tr>";html+="  <td align = center> El abono ha sido registrado.. </td>";html+=" </tr>";html+="</table>";this.finishedPanel.update(html);sink.Main.ui.setActiveItem(this.finishedPanel,'fade');};Aplicacion.Clientes.prototype.finishedPanelReimpresionTicket=null;Aplicacion.Clientes.prototype.finishedPanelShowReimpresionTicket=function(venta)
{this.finishedPanelReimpresionTicketUpdater(venta);action="sink.Main.ui.setActiveItem( Aplicacion.Clientes.currentInstance.detallesDeClientesPanel , 'slide');";setTimeout(action,4000);};Aplicacion.Clientes.prototype.finishedPanelReimpresionTicketUpdater=function(venta)
{if(DEBUG){console.log("finishedPanelReimpresionTicketUpdater()");}
var items=[];for(var i=0;i<venta.detalle_venta.length;i++){if(venta.detalle_venta[i].cantidad>0){items.push({cantidad:venta.detalle_venta[i].cantidad,descripcion:venta.detalle_venta[i].descripcion,precio:venta.detalle_venta[i].precio});}
if(venta.detalle_venta[i].cantidad_procesada>0){items.push({cantidad:venta.detalle_venta[i].cantidad_procesada-venta.detalle_venta[i].descuento,descripcion:venta.detalle_venta[i].descripcion,precio:venta.detalle_venta[i].precio_procesada});}}
for(i=0;i<POS.documentos.length;i++){if(POS.documentos[i].documento=='venta_cliente'){var impresora=POS.documentos[i].impresora;break;}}
var reimprimirVenta={tipo_venta:venta.tipo_venta,id_venta:venta.id_venta,cliente:{razon_social:venta.razon_social},items:items,tipo_pago:venta.tipo_pago,subtotal:venta.subtotal,empleado:venta.cajero,sucursal:POS.infoSucursal,total:venta.total,fecha_venta:venta.fecha,ticket:'venta_cliente',leyendasTicket:POS.leyendasTicket,reimpresion:true,impresora:impresora}
if(DEBUG){console.log("reimpresion de venta : ",reimprimirVenta);}
POS.ajaxToClient({module:"Printer",args:reimprimirVenta,success:function(r){if(DEBUG){console.log("ticket printing responded",r);}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});html="";html+="<table class='Mostrador-ThankYou'>";html+=" <tr>";html+="  <td ><img width = 200px height = 200px src='../media/Receipt128.png'></td>";html+="  <td></td>";html+=" </tr>";html+=" <tr>";html+="  <td align center >Reimprimendo ticket de venta...</td>";html+="  <td></td>";html+=" </tr>";html+="</table>";this.finishedPanelReimpresionTicket.update(html);sink.Main.ui.setActiveItem(this.finishedPanelReimpresionTicket,'fade');};Aplicacion.Clientes.prototype.finishedPanelCreatorReimpresionTicket=function()
{this.finishedPanelReimpresionTicket=new Ext.Panel({html:""});};Aplicacion.Clientes.prototype.FacturaPanel=null;Aplicacion.Clientes.prototype.facturaValidator=function(){var factura_generica=null;if(Ext.getCmp('facturaPanel-FacturaGenerica').getValue()==1){var str=Ext.getCmp('facturaPanel-Concepto').getValue();str=str.replace(/^\s*|\s*$/g,"");if(!(str.length>=5)){Ext.Msg.alert("Factura Cliente","El concepto de la factura generica es demaciado corta.");return;}
factura_generica={id_producto:'GEN01',descripcion:Ext.getCmp('facturaPanel-Concepto').getValue(),unidad:'unidad'};}
Ext.getBody().mask('Solicitando Factura ...','x-mask-loading',true);Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:1200,factura_generica:Ext.util.JSON.encode(factura_generica),id_venta:Ext.getCmp('facturaPanel-id_venta').getValue()},success:function(response,opts){var factura=null;try{factura=Ext.util.JSON.decode(response.responseText);}catch(e){Ext.getBody().unmask();Ext.Msg.alert("Error Factura Cliente","Error al momento de solicitar la factura : "+e+".");return;}
if(!factura.success){if(DEBUG){console.log("resultado de la factura sin exito ",factura);}
Ext.getBody().unmask();Ext.Msg.alert("Error Factura Cliente","Error al momento de solicitar la factura, intete mas tarde o solicitela al administrador. Mas informacion : "+factura.reason);return;}
if(DEBUG){console.log("resultado de la factura exitosa ",factura);}
Ext.getBody().unmask();Ext.Msg.alert("Factura Cliente","Se ha realizado correctamente la factura!!");window.open('http://pos.caffeina.mx/proxy.php?action=1308&id_venta='+Ext.getCmp('facturaPanel-id_venta').getValue());},failure:function(response){if(DEBUG){console.log("ya regrese del ajax, pero no habia conexion, estoy en el failure... hare una venta offline");}
Ext.getBody().unmask();POS.error(response);Ext.Msg.alert("Error Factura Cliente","Error al momento de solicitar la factura, al parecer esta presentando problemas con su conexion, intente mas tarde o solicitela al administrador.");}});};Aplicacion.Clientes.prototype.facturaPanelCreator=function(){var dockedItems=[new Ext.Toolbar({ui:'dark',dock:'bottom',items:[{xtype:'spacer'},{text:'Facturar Venta',id:'action-facturar-venta',ui:'forward',handler:function(){if(DEBUG){console.log("Facturando la venta : ",Aplicacion.Clientes.currentInstance.listaDeCompras.compraActual);}
Aplicacion.Clientes.currentInstance.facturaValidator();}}]})];this.FacturaPanel=new Ext.form.FormPanel({scroll:'vertical',items:[{xtype:'fieldset',title:'Facturación',instructions:'Llene correctamente todos los campos.',defaults:{disabled:false},items:[new Ext.form.Text({name:'facturaPanel-id_venta',id:'facturaPanel-id_venta',label:'Venta',value:''}),new Ext.form.Text({name:'facturaPanel-fecha',id:'facturaPanel-fecha',label:'Feha de Venta',value:''}),new Ext.form.Text({name:'facturaPanel-sucursal',id:'facturaPanel-sucursal',label:'Sucursal',value:''}),new Ext.form.Text({name:'facturaPanel-razon_social',id:'facturaPanel-razon_social',label:'Cliente',value:''}),new Ext.form.Text({name:'facturaPanel-cajero',id:'facturaPanel-cajero',label:'Cajero',value:''}),new Ext.form.Text({name:'facturaPanel-tipo_venta',id:'facturaPanel-tipo_venta',label:'Tipo de Venta',value:''}),new Ext.form.Text({name:'facturaPanel-total',id:'facturaPanel-total',label:'Total de la Compra',value:''}),new Ext.form.Text({name:'facturaPanel-pagado',id:'facturaPanel-pagado',label:'Total Pagado',value:''}),new Ext.form.Toggle({listeners:{"change":function(a,b,newVal,oldVal){if(newVal==1){Ext.getCmp('facturaPanel-Concepto').setValue("");Ext.getCmp('facturaPanel-Concepto').setVisible(true);}else{Ext.getCmp('facturaPanel-Concepto').setValue("");Ext.getCmp('facturaPanel-Concepto').setVisible(false);}}},id:'facturaPanel-FacturaGenerica',label:'Active para factura generica'}),new Ext.form.Text({label:'Concepto',id:'facturaPanel-Concepto',hidden:true,listeners:{'focus':function(){kconf={type:'alfanum',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}})]}],dockedItems:dockedItems});};Aplicacion.Clientes.prototype.factura=function(){Ext.getBody().mask('Creando Factura ...','x-mask-loading',true);Ext.getBody().unmask();Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:1200,factura_generica:factura_generica,id_venta:id_venta},success:function(response,opts){try{r=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(e);}
Ext.getBody().unmask();if(!r.success){return;}}});};POS.Apps.push(new Aplicacion.Clientes());Aplicacion.Inventario=function(){return this._init();};Aplicacion.Inventario.prototype._init=function(){if(DEBUG){console.log("Inventario: construyendo");}
this.cargarInventario();this.listaInventarioPanelCreate();this.detalleInventarioPanelCreator();this.surtirWizardCreator();this.procesarProducto=new Aplicacion.Inventario.ProcesarProducto();Aplicacion.Inventario.currentInstance=this;return this;};Aplicacion.Inventario.prototype.getConfig=function(){if(POS.U.g===null){window.location="sucursal.html";}
return{text:'Inventario',cls:'launchscreen',card:this.listaInventarioPanel,leaf:true};};Ext.regModel('listaInventarioModel',{fields:[{name:'descripcion',type:'string'},{name:'productoID',type:'int'},{name:'medida',type:'string'},{name:'agrupacionTam',type:'float'},{name:'precioPorAgrupacion',type:'bool'},{name:'precioVenta',type:'float'},{name:'precioVentaProcesado',type:'float'},{name:'existencias',type:'float'},{name:'existenciasOriginales',type:'float'},{name:'existenciasProcesadas',type:'float'},{name:'precioIntersucursal',type:'float'},{name:'precioIntersucursalProcesado',type:'float'}]});Aplicacion.Inventario.prototype.inventarioListaStore=new Ext.data.Store({model:'listaInventarioModel',sorters:'descripcion',getGroupString:function(record){var s=record.get('descripcion');return s.split(" ")[0];}});Aplicacion.Inventario.prototype.Inventario={lista:null,lastUpdate:null};Aplicacion.Inventario.prototype.cargarInventario=function()
{if(DEBUG){console.log("Cargando el inventario online...");}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:400},success:function(response,opts){try{inventario=Ext.util.JSON.decode(response.responseText);inventario2=Ext.util.JSON.decode(response.responseText);}catch(e){return POS.error(response,e);}
if(!inventario.success){return this.cargarInventario();}
for(i_index=0;i_index<inventario2.datos.length;i_index++){prod=new Inventario({id_producto:parseInt(inventario2.datos[i_index].productoID),descripcion:inventario2.datos[i_index].descripcion,escala:inventario2.datos[i_index].medida,tratamiento:inventario2.datos[i_index].tratamiento,agrupacion:inventario2.datos[i_index].agrupacion,agrupacionTam:parseFloat(inventario2.datos[i_index].agrupacionTam),activo:1,precio_por_agrupacion:1});prod.save(function(r){});}
if(DEBUG){console.log("Inventario retrived !",inventario);}
this.Inventario.productos=inventario.datos;this.Inventario.lastUpdate=Math.round(new Date().getTime()/1000.0);this.Inventario.hash=inventario.hash;if(DEBUG){console.log("Insertando el inventario en el store !",inventario.datos);}
this.inventarioListaStore.loadData(inventario.datos);if(DEBUG){console.log("Asi quedo el store",this.inventarioListaStore);}},failure:function(response){POS.error(response);}});};Aplicacion.Inventario.prototype.listaInventarioPanel=null;Aplicacion.Inventario.prototype.listaInventarioPanelShow=function()
{if(this.listaInventarioPanel){this.listaInventarioPanelShow();}else{this.listaInventarioPanelCreate();}
sink.Main.ui.setActiveItem(this.listaInventarioPanel,'slide');};Aplicacion.Inventario.crearHtmlDeInventario=function(){var inventario=Aplicacion.Inventario.currentInstance.inventarioListaStore,html="",tmp_qty=0;inventario.clearFilter();html+="<table border=0 style='width:100%; font-size: 16px;'>"
+"<tr style='font-size: 16px; ' >"
+"<td style='padding-left: 7px;'>Producto</td>"
+"<td>Existencias Originales</td>"
+"<td>Precio</td>"
+"<td>Existencias Procesadas</td>"
+"<td>Precio</td>"
+"<td></td>"
+"</tr>";console.log(inventario.getAt(0).data)
for(var i=0;i<inventario.getCount();i++){style="height: 80px;";style+="border-top: 1px solid #D1D1D1;";style+="text-shadow: rgba(255, 255 , 255, 0.5) 0 -0.08em 0;"
r=inventario.getAt(i);html+="<tr style='"+style+"' >";html+="<td style='padding-left: 5px'>"+r.get("productoID")+" "+r.get("descripcion")+"</td>";html+="<td>"+r.get("existenciasOriginales")+" "+r.get("medida")+"s ";if(r.get("agrupacion")!=null){if(parseFloat(r.get("agrupacionTam"))==0){tmp_qty="!";}else{tmp_qty=parseFloat(r.get("existenciasOriginales"))/parseFloat(r.get("agrupacionTam"));tmp_qty=tmp_qty.toFixed(2);}
html+="<br>( "+tmp_qty+" "+r.get("agrupacion")+"s )";}
html+="</td>";html+="<td>"+POS.currencyFormat(r.get("precioVenta"))+" ";if(r.get("precioPorAgrupacion")){html+=" por "+r.get("agrupacion");}else{html+=" por "+r.get("medida");}
html+="</td>";if(r.get("tratamiento")==null){html+="<td ></td><td></td>"}else{html+="<td>"+r.get("existenciasProcesadas")+" "+r.get("medida")+"s ";if(r.get("agrupacion")!=null){if(parseFloat(r.get("agrupacionTam"))==0){tmp_qty="!";}else{tmp_qty=parseFloat(r.get("existenciasProcesadas"))/parseFloat(r.get("agrupacionTam"));tmp_qty=tmp_qty.toFixed(2);}
html+="<br>( "+tmp_qty+" "+r.get("agrupacion")+"s )";}
html+="</td>";html+="<td>"+POS.currencyFormat(r.get("precioVentaProcesado"))+" ";if(r.get("precioPorAgrupacion")){html+=" por "+r.get("agrupacion");}else{html+=" por "+r.get("medida");}
html+="</td>";}
html+="<td onclick='Aplicacion.Inventario.currentInstance.detalleInventarioPanelShow("+r.get("productoID")+")'  ><img src='../media/arrow2.png' ></td>";html+="</tr>";};html+="</table>";return html;}
Aplicacion.Inventario.prototype.listaInventarioPanelCreate=function()
{var buscar={xtype:'textfield',placeHolder:"Buscar",listeners:{'focus':function(){kconf={type:'alfa',submitText:'Buscar',callback:null};POS.Keyboard.Keyboard(this,kconf);}}};var dockedItems={xtype:'toolbar',dock:'bottom',items:[buscar,{xtype:'spacer'}]};this.listaInventarioPanel=new Ext.Panel({layout:'fit',html:"",scroll:"vertical",listeners:{"render":function(){this.update(Aplicacion.Inventario.crearHtmlDeInventario());},"show":function(){this.update(Aplicacion.Inventario.crearHtmlDeInventario());}}});};Aplicacion.Inventario.prototype.detalleInventarioPanel=null;Aplicacion.Inventario.prototype.detalleInventarioPanelShow=function(id_producto)
{if(this.detalleInventarioPanel){this.detalleInventarioPanelCreator();}
var inventario=Aplicacion.Inventario.currentInstance.inventarioListaStore;producto=inventario.findRecord("productoID",id_producto)
this.detalleInventarioPanelUpdater(producto);sink.Main.ui.setActiveItem(this.detalleInventarioPanel,'slide');};Aplicacion.Inventario.prototype.detalleInventarioPanelUpdater=function(producto)
{if(DEBUG){console.log("updating detalles del producto",producto);}
detallesPanel=Aplicacion.Inventario.currentInstance.detalleInventarioPanel;if(producto.get("tratamiento")){}else{}
Aplicacion.Inventario.currentInstance.procesarProducto.setProducto(producto);if((producto.get("tratamiento")===null)||(producto.get("tratamiento")===false)){Ext.getCmp("Aplicacion.Inventario.detalles.existenciasProcesadas").hide();}else{Ext.getCmp("Aplicacion.Inventario.detalles.existenciasProcesadas").show();}
var precio_txt=POS.currencyFormat(producto.get('precioVenta'))+" por ";if(producto.get("precioPorAgrupacion")){precio_txt+=producto.get("agrupacion");}else{precio_txt+=producto.get("medida");}
var cantidad_txt=" ";if(producto.get("agrupacion")){var qty=parseFloat(producto.get('existenciasOriginales'))/parseFloat(producto.get("agrupacionTam"));cantidad_txt=producto.get('existenciasOriginales')+" "+producto.get("medida")+"s";cantidad_txt+=" ( "+qty.toFixed(2)+" "+producto.get("agrupacion")+"s )";}else{cantidad_txt=producto.get('existenciasOriginales')+" "+producto.get("medida")+"s";}
detallesPanel.setValues({productoID:producto.get('productoID'),descripcion:producto.get('descripcion'),precioVenta:precio_txt,existenciasOriginales:cantidad_txt,existenciasProcesadas:producto.get('existenciasProcesadas')+" "+producto.get('medida')+"s"});};Aplicacion.Inventario.prototype.detalleInventarioPanelCreator=function()
{opciones=[{text:'Regresar a Inventario',ui:'back',handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Inventario.currentInstance.listaInventarioPanel,'slide');}},{text:'Agregar a Mostrador',ui:'normal',handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Mostrador.currentInstance.mostradorPanel,'slide');var id=Aplicacion.Inventario.currentInstance.detalleInventarioPanel.getValues().productoID;Aplicacion.Mostrador.currentInstance.agregarProductoPorID(id);}},{text:'Agregar a Compras Mostrador',ui:'normal',handler:function(){sink.Main.ui.setActiveItem(Aplicacion.ComprasMostrador.currentInstance.mostradorPanel,'slide');var id=Aplicacion.Inventario.currentInstance.detalleInventarioPanel.getValues().productoID;Aplicacion.ComprasMostrador.currentInstance.agregarProductoPorID(id);}}];if(POS.U.g){opciones.push({text:'Procesar este producto',id:"procesarProductoBoton",ui:"action",handler:function(){var thiz=Aplicacion.Inventario.currentInstance;sink.Main.ui.setActiveItem(thiz.procesarProducto.getPanel(),'slide');},listeners:{"show":function(){var vals=Aplicacion.Inventario.currentInstance.detalleInventarioPanel.getValues();if(vals.tratamiento){Ext.get("procesarProductoBoton").hide();}else{Ext.get("procesarProductoBoton").show();}}}});}
var dockedItems=[new Ext.Toolbar({ui:'dark',dock:'bottom',items:[{xtype:"spacer"}].concat(opciones)})];this.detalleInventarioPanel=new Ext.form.FormPanel({dockedItems:dockedItems,items:[{xtype:'fieldset',title:'Detalles de Producto',scroll:false,instructions:'',defaults:{disabled:false},items:[new Ext.form.Text({name:'productoID',label:'ID del producto'}),new Ext.form.Text({name:'descripcion',label:'Descripcion'}),new Ext.form.Text({name:'precioVenta',label:'Precio sugerido'}),new Ext.form.Text({id:'Aplicacion.Inventario.detalles.existenciasProcesadas',name:'existenciasProcesadas',label:'Existencias procesadas'}),new Ext.form.Text({id:'Aplicacion.Inventario.detalles.existenciasOriginales',name:'existenciasOriginales',label:'Existencias originales'})]}]});};Aplicacion.Inventario.prototype.detalleInventarioSurtirEsteProd=function()
{if(DEBUG){console.log("surtiendo producto "+Aplicacion.Inventario.currentInstance.detalleInventarioPanel.getRecord().data.productoID);}
sink.Main.ui.setActiveItem(Aplicacion.Inventario.currentInstance.surtirWizardPanel,'fade');Aplicacion.Inventario.currentInstance.surtirAddItem(Aplicacion.Inventario.currentInstance.detalleInventarioPanel.getRecord().data);};Aplicacion.Inventario.prototype.carritoCambiarCantidad=function(id,qty,forceNewValue)
{carrito=this.carritoSurtir;for(var i=carrito.items.length-1;i>=0;i--){if(carrito.items[i].idUnique==id){if(forceNewValue){carrito.items[i].cantidad=qty;}else{carrito.items[i].cantidad+=qty;}
if(carrito.items[i].cantidad<=0){carrito.items[i].cantidad=1;}
this.refreshSurtir();break;}}};Aplicacion.Inventario.prototype.carritoSurtir={items:[],otherData:null};Aplicacion.Inventario.prototype.idUnique=0;Aplicacion.Inventario.prototype.copy=function(o){if(typeof o!="object"||o===null)return o;var r=o.constructor==Array?[]:{};for(var i in o){r[i]=this.copy(o[i]);}
return r;};Aplicacion.Inventario.prototype.surtirAddItem=function(item)
{if(DEBUG){console.log("Agregnado producto ",item," a la peticion");}
var cont_prod=0;for(var i=this.carritoSurtir.items.length-1;i>=0;i--){if(this.carritoSurtir.items[i].productoID==item.productoID){cont_prod++;}
if(cont_prod>=2){if(DEBUG){console.log("este producto ya existe en el carrito para surtir");}
Ext.Msg.alert("Proveedores","El producto "+item.descripcion+" ya se encuentra en el carrito");return;}
this.refreshSurtir();}
item.cantidad=1;item.procesado="true";this.idUnique++;if(DEBUG){console.log("Aplicacion.Inventario.currentInstance.idUnique : ",this.idUnique);}
var _item=this.copy(item);_item.idUnique=_item.productoID+"_"+this.idUnique;this.carritoSurtir.items.push(_item);if(DEBUG){console.log("Agregado al carrito : ",_item);}
this.refreshSurtir();};Aplicacion.Inventario.prototype.refreshSurtir=function()
{if(DEBUG){console.log("Refrescanco el carrito para surtir...");}
carrito=this.carritoSurtir;if(carrito.items.length>0){Ext.getCmp("Inventario-confirmarPedido").show(Ext.anims.slide);}else{Ext.getCmp("Inventario-confirmarPedido").hide(Ext.anims.slide);}
var html="<table border=0>";html+="<tr class='top'>";html+="<td>Descripcion</td>";html+="<td>&nbsp;</td>";html+="<td>&nbsp;</td>";html+="<td align='center'  colspan=4>Cantidad</td>";html+="</tr>";for(var i=0;i<carrito.items.length;i++){if(carrito.items[i].cantidad===null){carrito.items[i].cantidad=1;}
if(i==carrito.items.length-1)
html+="<tr class='last'>";else
html+="<tr >";var m;switch(carrito.items[i].medida){case"kilogramo":m="kgs";break;case"pieza":m="pzas";break;case"litro":m="lts";break;}
html+="<td style='width: 25%;' ><b>"+carrito.items[i].productoID+"</b> &nbsp; "+carrito.items[i].descripcion+"</td>";html+="<td style='width: 15%;' > <div id='Inventario-carritoTipo"+carrito.items[i].idUnique+"'></div></td>";html+="<td style='width: 8%;' > <span class = 'boton' onClick = 'Aplicacion.Inventario.currentInstance.quitarDelCarrito("+carrito.items[i].idUnique+")'><img src='../media/icons/close_16.png'></span> </td>";html+="<td  align='center'  style='width: 6.1%;'> <span class='boton' onClick=\"Aplicacion.Inventario.currentInstance.carritoCambiarCantidad('"+carrito.items[i].idUnique+"', -1, false)\">&nbsp;-&nbsp;<img src='../media/icons/arrow_down_16.png'></span></td>";html+="<td style='width: 6.8%;' > <div id='Inventario-carritoCantidad"+carrito.items[i].idUnique+"'></div></td><td>"+m+"</td>";html+="<td  align='center'  style='width: 6.1%;'> <span class='boton' onClick=\"Aplicacion.Inventario.currentInstance.carritoCambiarCantidad('"+carrito.items[i].idUnique+"', 1, false)\"><img src='../media/icons/arrow_up_16.png'>&nbsp;+&nbsp;</span></td>";html+="</tr>";}
html+="</table>";Ext.getCmp("Inventario-surtirTabla").update(html);for(i=0;i<carrito.items.length;i++){a=new Ext.form.Text({renderTo:"Inventario-carritoCantidad"+carrito.items[i].idUnique,id:"Inventario-carritoCantidad"+carrito.items[i].idUnique+"Text",value:carrito.items[i].cantidad,idUnique:carrito.items[i].idUnique,placeHolder:"Cantidad",listeners:{'focus':function(){kconf={type:'num',submitText:'Aceptar',callback:function(campo){carrito=Aplicacion.Inventario.currentInstance.carritoSurtir;for(var j=0;j<carrito.items.length;j++){if(campo.idUnique==carrito.items[j].idUnique){carrito.items[j].cantidad=parseFloat(campo.getValue());break;}}
Aplicacion.Inventario.currentInstance.refreshSurtir();}};POS.Keyboard.Keyboard(this,kconf);}}});b=new Ext.form.Select({renderTo:"Inventario-carritoTipo"+carrito.items[i].idUnique,id:"Inventario-carritoTipo"+carrito.items[i].idUnique+"Value",idUnique:carrito.items[i].idUnique,value:carrito.items[i].procesado,options:[{text:'Procesada',value:'true'},{text:'Original',value:'false'}],listeners:{"change":function(){carrito=Aplicacion.Inventario.currentInstance.carritoSurtir
for(var i=carrito.items.length-1;i>=0;i--){if(carrito.items[i].idUnique==this.idUnique){carrito.items[i].procesado=this.getValue();}}}}});}};Aplicacion.Inventario.prototype.quitarDelCarrito=function(id_producto)
{if(DEBUG){console.log("Removiendo del carrito.");}
carrito=Aplicacion.Inventario.currentInstance.carritoSurtir;for(var i=carrito.items.length-1;i>=0;i--){if(carrito.items[i].idUnique==iidUnique){carrito.items.splice(i,1);break;}}
Aplicacion.Inventario.currentInstance.refreshSurtir();};Aplicacion.Inventario.prototype.surtirWizardPanel=null;Aplicacion.Inventario.prototype.surtirWizardFromProveedor=false;Aplicacion.Inventario.prototype.surtirWizardCreator=function(){if(DEBUG){console.log("Creando wizard par surtir")}
bar=[{text:'Agregar producto',ui:'normal',handler:function(t){Aplicacion.Inventario.currentInstance.surtirWizardPopUpPanel.showBy(this);}},{xtype:'spacer'},{text:'Cancelar pedido',ui:'normal',handler:function(t){Aplicacion.Inventario.currentInstance.carritoSurtir.items=[];Aplicacion.Inventario.currentInstance.refreshSurtir();}},{text:'Confirmar pedido',ui:'action',hidden:true,id:'Inventario-confirmarPedido',handler:function(t){Aplicacion.Inventario.currentInstance.surtirCarritoValidator();}}];this.surtirWizardPanel=new Ext.Panel({dockedItems:new Ext.Toolbar({ui:'dark',dock:'bottom',items:bar}),html:"",id:"Inventario-surtirTabla",cls:"Tabla"});this.surtirWizardPopUpPanel=new Ext.Panel({floating:true,centered:true,modal:true,width:475,height:450,dockedItems:[{dock:'top',xtype:'toolbar',title:'Seleccione el producto'},{dock:'bottom',xtype:'toolbar',items:[{text:'Cancelar',handler:function(){Aplicacion.Inventario.currentInstance.surtirWizardPopUpPanel.hide();}},{xtype:'spacer'},{text:'Seleccionar',ui:'action',handler:function(){r=Aplicacion.Inventario.currentInstance.surtirWizardPopUpPanel.getComponent(0).getSelectedRecords();for(a=0;a<r.length;a++){Aplicacion.Inventario.currentInstance.surtirAddItem(r[a].data);}
Aplicacion.Inventario.currentInstance.surtirWizardPopUpPanel.hide();}}]}],items:[{multiSelect:true,xtype:'list',ui:'dark',layout:'fit',store:this.inventarioListaStore,itemTpl:'<div class=""><b>{productoID}</b> {descripcion}</div>',indexBar:false}]});};Aplicacion.Inventario.prototype.surtirWizardPopUpPanel=null;Aplicacion.Inventario.prototype.surtirCarritoValidator=function(){for(var i=0;i<this.carritoSurtir.items.length;i++)
{if(!(this.carritoSurtir.items[i].cantidad&&/^\d+(\.\d+)?$/.test(this.carritoSurtir.items[i].cantidad+''))){Ext.Msg.alert("Inventario","Error: verifique la cantidad del producto: "+this.carritoSurtir.items[i].descripcion);return;}}
Aplicacion.Inventario.currentInstance.surtirCarrito();}
Aplicacion.Inventario.prototype.surtirCarrito=function(){if(this.surtirWizardFromProveedor){if(DEBUG){console.log("Surtiendo para proveedor ");}}else{if(DEBUG){console.log("Surtiendo para centro de distribucion ");}}
for(var i=0;i<this.carritoSurtir.items.length;i++)
{this.carritoSurtir.items[i].id_producto=this.carritoSurtir.items[i].productoID;}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:this.surtirWizardFromProveedor?903:209,data:Ext.util.JSON.encode(this.carritoSurtir.items)},success:function(response,opts){try{r=Ext.util.JSON.decode(response.responseText);}catch(e){return POS.error(response,e);}
if(!r.success){Ext.Msg.alert("Inventario","Intente de nuevo");Aplicacion.Inventario.currentInstance.carritoSurtir.items=[];Aplicacion.Inventario.currentInstance.refreshSurtir();return;}
Ext.Msg.alert("Inventario","Solicitud enviada con exito");Aplicacion.Inventario.currentInstance.carritoSurtir.items=[];Aplicacion.Inventario.currentInstance.refreshSurtir();},failure:function(response){POS.error(response);}});};Aplicacion.Inventario.ProcesarProducto=function(){var panel,producto,listaDeProductos,crearPanel,updatePanel,validar,panelDetalles,otrosProductos,foo,carritoDeDerivados=[],renderCarrito;crearPanel=function(){panelDetalles=new Ext.form.FormPanel({items:[{xtype:'fieldset',title:'Detalles de proceso',instructions:'',defaults:{disabled:false},items:[new Ext.form.Text({name:'tomado',label:'Tomado para procesar'}),new Ext.form.Text({name:'resultante',label:'Resultante procesado',listeners:{"focus":function(){kconf={type:'num',submitText:'Aceptar',callback:null};if(DEBUG){console.log(this)}
POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Text({name:'merma',label:'Merma resultante',listeners:{"focus":function(){kconf={type:'num',submitText:'Aceptar',callback:null};if(DEBUG){console.log(this)}
POS.Keyboard.Keyboard(this,kconf);}}})]}]});otrosProductos=new Ext.Panel({padding:"20%",cls:"Tabla",html:""});panel=new Ext.Panel({layout:{type:'vbox',padding:'5',align:'left'},dockedItems:[{dock:'bottom',xtype:'toolbar',items:[{text:'Regresar a detalles de producto',ui:'back',handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Inventario.currentInstance.detalleInventarioPanel,'slide');}},{xtype:'spacer'},{text:'Agregar producto resultante',ui:'normal',handler:function(){Aplicacion.Inventario.currentInstance.procesarProducto.mostrarLista(this);}},{text:'Registar proceso',ui:'action',handler:function(){Aplicacion.Inventario.currentInstance.procesarProducto.send();}}]}],items:[panelDetalles,otrosProductos]});var productoDerivadoDetallesPanel=new Ext.form.FormPanel({dockedItems:[{dock:'bottom',xtype:'toolbar',items:[{text:'Cancelar',handler:function(){Aplicacion.Inventario.currentInstance.procesarProducto.getListaDeProductosPanel().hide();}},{xtype:'spacer'},{text:'Aceptar',ui:'action',handler:function(){var pp=Aplicacion.Inventario.currentInstance.procesarProducto;pp.agregarProductoDerivado(Ext.getCmp("inventario_producto_derivado_qty").getValue());pp.getListaDeProductosPanel().hide();}}]}],items:[{xtype:'fieldset',title:'Detalles de producto derivado',instructions:'',defaults:{disabled:false,labelAlign:"top",labelWidth:"100%"},items:[new Ext.form.Text({name:'derivado_resultante',id:'inventario_producto_derivado_qty',label:'Resultante',labelAlign:"top",listeners:{"focus":function(){POS.Keyboard.KeyboardObj=null;kconf={type:'num',submitText:'Aceptar',callback:null};POS.Keyboard.Keyboard(this,kconf);}}})]}]});listaDeProductos=new Ext.Panel({floating:true,ui:"dark",layout:"card",modal:false,scroll:false,width:300,height:500,showAnimation:Ext.anims.fade,hideOnMaskTap:false,bodyPadding:0,bodyMargin:0,styleHtmlContent:false,listeners:{"show":function(){updatePanel();this.setActiveItem(0);},"hide":function(){var store;store=Aplicacion.Inventario.currentInstance.inventarioListaStore;store.clearFilter();}},items:[{multiSelect:true,xtype:'list',ui:'dark',store:null,itemTpl:'<div class=""><b>{productoID}</b> {descripcion}</div>',grouped:false,indexBar:false,listeners:{"selectionchange":function(view,nodos,c){var panel;if(nodos.length>0){panel=Aplicacion.Inventario.currentInstance.procesarProducto.getListaDeProductosPanel();panel.setActiveItem(productoDerivadoDetallesPanel,Ext.anims.slide);foo=nodos[0];}}}}]});if(DEBUG){console.log("Creando panel de procesado con ",panelDetalles,otrosProductos,panel);}};updatePanel=function(){var store;store=Aplicacion.Inventario.currentInstance.inventarioListaStore;store.clearFilter();store.filterBy(function(record){if(record.get("productoID")==producto.get("productoID")){return false;}
for(var i=carritoDeDerivados.length-1;i>=0;i--){if(record.get("productoID")==carritoDeDerivados[i].get("productoID")){return false;}};return true;});listaDeProductos.getComponent(0).bindStore(store);return true;};validar=function(){var detalles=panelDetalles.getValues();if(DEBUG){console.log("Validando detalles ",detalles,producto);}
var totalTomado=parseFloat(detalles.merma)+parseFloat(detalles.resultante);if(parseFloat(producto.get("existenciasOriginales"))<totalTomado){return false;}
return true;};renderCarrito=function(){var html;if(DEBUG){console.log("Re-rendereando el carrito",otrosProductos);}
html='<table style="width: 100%" >';html+='<tr> <th> Producto </th><th> Cantidad resultante del proceso </th> </tr>';for(var i=carritoDeDerivados.length-1;i>=0;i--){html+='<tr>';html+='<td><b>'+carritoDeDerivados[i].get("productoID")+'</b> '+carritoDeDerivados[i].get("descripcion")+'</td>';html+='<td>'+carritoDeDerivados[i].get("cantidad")+carritoDeDerivados[i].get("medida")+'s</td>';html+='</tr>';};html+='</table>';otrosProductos.update(html);};this.agregarProductoDerivado=function(qty){if(DEBUG){console.log("Agregando producto derivado",foo);}
for(var i=carritoDeDerivados.length-1;i>=0;i--){if(carritoDeDerivados[i].get("productoID")==foo.get("productoID")){return;}};foo.set("cantidad",qty)
carritoDeDerivados.push(foo);renderCarrito();}
this.getListaDeProductosPanel=function(){return listaDeProductos;};this.mostrarLista=function(where){listaDeProductos.showBy(where);}
this.getPanel=function(){updatePanel();return panel;};this.setProducto=function(productoStore){producto=productoStore;}
this.send=function(){var detalles,data;if(!validar()){Ext.Msg.alert("Procesar producto","No hay suficiente producto orginal para procesar esta cantidad");return false;}
Ext.getBody().mask('Enviando proceso','x-mask-loading',true);detalles=panelDetalles.getValues();if(DEBUG){console.log("carritoDeDerivados : ",carritoDeDerivados);}
var array_derivados=[];for(var i=0;i<carritoDeDerivados.length;i++){array_derivados.push({id_producto:carritoDeDerivados[i].data.productoID,procesado:carritoDeDerivados[i].data.cantidad});}
if(DEBUG){console.log("array_derivados  : ",array_derivados);}
data={id_producto:producto.get("productoID"),procesado:detalles.resultante,desecho:detalles.merma,subproducto:array_derivados};Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:408,data:Ext.util.JSON.encode(data)},success:function(response,opts){Ext.getBody().unmask();try{respuesta=Ext.util.JSON.decode(response.responseText);}catch(e){return POS.error(e);}
if(respuesta.success){Ext.Msg.alert("Procesar producto","Producto procesado correctamente");action=Aplicacion.Inventario.currentInstance.cargarInventario();setTimeout(action,2000);}else{Ext.Msg.alert("Procesar producto",respuesta.reason);return;}
if(DEBUG){console.log("Regrese de procesar producto en suscursal",respuesta);}
Aplicacion.Inventario.currentInstance.detalleInventarioPanelShow(producto);}});}
crearPanel();};POS.Apps.push(new Aplicacion.Inventario());Aplicacion.Mostrador=function()
{return this._init();};Aplicacion.Mostrador.prototype._init=function(){if(DEBUG){console.log("Mostrador: construyendo");}
this.checkForOfflineSales();this.mostradorPanelCreator();this.buscarClienteFormCreator();this.doNuevaVentaPanelCreator();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Efectivo').hide();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Cheque').hide();this.finishedPanelCreator();Aplicacion.Mostrador.currentInstance=this;return this;};Aplicacion.Mostrador.prototype.getConfig=function(){return{text:'Mostrador de ventas',cls:'launchscreen',card:this.mostradorPanel,leaf:true};};Aplicacion.Mostrador.prototype.checkForOfflineSales=function()
{Ventas.getAll({context:this,callback:function(f){if(DEBUG){if(f.length>0){console.log("HAY "+f.length+" ventas pendientes !");}}
if(f.length>0){this.sendOfflineSales(f);}else{if(DEBUG){console.log("no hay ventas pendientes en la base de datos local");}}}});}
Aplicacion.Mostrador.prototype.sendOfflineSales=function(ventas)
{if(DEBUG){console.log("Enviando ventas offline ....");}
DetalleVenta.getAll({context:this,callback:function(detallesVentas){if(DEBUG){console.log("ya tengo los detalles de ventas..",detallesVentas," para las ventas : ",ventas);}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:199,payload:Ext.util.JSON.encode({ventas:ventas,detalles:detallesVentas})},success:function(response){if(DEBUG){console.log("ya regrese de enviar las ventas offline... a borrarlas de la bd");}
for(var v_i=0;v_i<ventas.length;v_i++){ventas[v_i].destruct({callback:Ext.emptyFn});}
for(var dv_i=0;dv_i<detallesVentas.length;dv_i++){detallesVentas[dv_i].destruct({callback:Ext.emptyFn});}}});}});}
Aplicacion.Mostrador.prototype.carrito={tipo_venta:null,items:[],cliente:null,venta_preferencial:{cliente:null,id_autorizacion:null},factura:false,tipo_pago:null};Aplicacion.Mostrador.prototype.cancelarVenta=function()
{if(DEBUG){console.log("------cancelando venta------");}
Aplicacion.Mostrador.currentInstance.carrito.items=[];Aplicacion.Mostrador.currentInstance.refrescarMostrador();Aplicacion.Mostrador.currentInstance.setCajaComun();};Aplicacion.Mostrador.prototype.carritoCambiarCantidad=function(id,qty,forceNewValue)
{var carrito=Aplicacion.Mostrador.currentInstance.carrito.items;for(var i=carrito.length-1;i>=0;i--){if(carrito[i].idUnique==id){if(forceNewValue){carrito[i].cantidad=qty;}else{carrito[i].cantidad+=qty;}
if(carrito[i].cantidad<=0){carrito[i].cantidad=1;}
this.refrescarMostrador();break;}}};Aplicacion.Mostrador.prototype.refrescarMostrador=function()
{carrito=Aplicacion.Mostrador.currentInstance.carrito;var html="<table border=0  style='font-size: 14px;border: 1px solid #DDD;' >";html+="<tr class='top'>";html+="<td align='left'>Descripcion</td>";html+="<td>&nbsp</td>";html+="<td align='center' colspan=5>Cantidad</td>";html+="<td>Descuento</td>";html+="<td align='left' >Total</td>";html+="<td align='left' >Precio</td>";html+="<td align='left' >Sub Total</td>";html+="</tr>";var venta_intersucursal=false;if(carrito.cliente!=null&&carrito.cliente.id_cliente<0){venta_intersucursal=true;if(DEBUG){console.log("venta_ intersucursal activada");}}
var stotal=0;for(var i=0;i<carrito.items.length;i++){var productoI=inventario.findRecord("productoID",carrito.items[i].id_producto,0,false,true,true);switch(productoI.get("medida")){case"pieza":carrito.items[i].cantidad=Math.round(carrito.items[i].cantidad);if(DEBUG){console.log("ROUNDING:",carrito.items[i].cantidad,Math.round(carrito.items[i].cantidad));}
break;default:}
if(parseFloat(productoI.get("existencias"))==0){if(DEBUG){console.log("No hay originales !!");}
carrito.items[i].procesado="true";}
if(parseFloat(productoI.get("existenciasProcesadas"))==0){if(DEBUG){console.log("No hay procesadas !!");}
carrito.items[i].procesado="false";}
if(carrito.items[i].tratamiento!=null){if(carrito.items[i].procesado=="true"){if(DEBUG){console.log("quiero "+carrito.items[i].cantidad+" procesadas y hay "+productoI.get("existenciasProcesadas"));}
if(parseFloat(productoI.get("existenciasProcesadas"))<parseFloat(carrito.items[i].cantidad)){carrito.items[i].cantidad=parseFloat(productoI.get("existenciasProcesadas"));Ext.Msg.alert("Mostrador","No hay suficientes existencias de "+productoI.get("descripcion"));}}else{if(DEBUG){console.log("quiero "+carrito.items[i].cantidad+" originales y hay "+productoI.get("existencias"));}
if(parseFloat(productoI.get("existencias"))<parseFloat(carrito.items[i].cantidad)){carrito.items[i].cantidad=parseFloat(productoI.get("existencias"));Ext.Msg.alert("Mostrador","No hay suficientes existencias de "+productoI.get("descripcion"));}}}else{if(parseFloat(productoI.get("existencias"))<parseFloat(carrito.items[i].cantidad)){carrito.items[i].cantidad=parseFloat(productoI.get("existencias"));Ext.Msg.alert("Mostrador","No hay suficientes existencias de "+productoI.get("descripcion"));}}
var color=i%2==0?"":"style='background-color:#f7f7f7;'";color="";html+="<tr "+color+">";html+="<td style='width: 18.7%;' ><b>"+carrito.items[i].id_producto+"</b> &nbsp;"+carrito.items[i].descripcion+"</td>";html+="<td style='width: 12%;' ><div id='Mostrador-carritoTratamiento"+carrito.items[i].idUnique+"'></div></td>";html+="<td  align='right' style='width:4%;'> <span class='boton'  onClick=\"Aplicacion.Mostrador.currentInstance.quitarDelCarrito('"+carrito.items[i].idUnique+"')\"><img src='../media/icons/close_16.png'></span></td>";html+="<td  align='center'  style='width: 8.1%;'> <span class='boton' onClick=\"Aplicacion.Mostrador.currentInstance.carritoCambiarCantidad('"+carrito.items[i].idUnique+"', -1, false)\"><img src='../media/icons/arrow_down_16.png'></span></td>";var escala_de_compra;if(productoI.get("precioPorAgrupacion")){escala_de_compra=productoI.get("agrupacion");}else{switch(productoI.get("medida")){case"kilogramo":escala_de_compra="Kgs";break;case"pieza":escala_de_compra="Pzas";break;case"litro":escala_de_compra="Lts.";break;}}
html+="<td  align='center'  style='width: 7.2%;' ><div id='Mostrador-carritoCantidad"+carrito.items[i].idUnique+"'></div></td><td>"+escala_de_compra+"</td>";html+="<td  align='center'  style='width: 8.1%;'> <span class='boton' onClick=\"Aplicacion.Mostrador.currentInstance.carritoCambiarCantidad('"+carrito.items[i].idUnique+"', 1, false)\"><img src='../media/icons/arrow_up_16.png'></span></td>";html+="<td style='width: 8%;' ><div id='Mostrador-carritoDescuento"+carrito.items[i].idUnique+"'></div></td>";html+="<td  align='center'  style='width: 6.3%;' ><div >"+(carrito.items[i].cantidad-carrito.items[i].descuento)+" "+escala_de_compra+"</div></td>";html+="<td style='width: 10.4%;'> <div  id='Mostrador-carritoPrecio"+carrito.items[i].idUnique+"'></div></td>";html+="<td  style='width: 11.3%;'><div  id='Mostrador-carritoSubtotal"+carrito.items[i].idUnique+"'></div</td>";html+="</tr>";stotal+=((carrito.items[i].cantidad-carrito.items[i].descuento)*carrito.items[i].precio);}
var style="";style+="font-weight: bold;";style+="color: black;";if(carrito.items.length>0){html+="<tr class='last' style='"+style+"' align=right>";html+=" <td colspan=9></td>";html+=" <td style='text-align:right'>Total</td>";html+=" <td style='text-align:left'>"+POS.currencyFormat(stotal)+"</td>";html+="</tr>";}
html+="</table>";Ext.getCmp("MostradorHtmlPanel").update(html);if(carrito.items.length>0){Ext.getCmp("Mostrador-mostradorVender").show(Ext.anims.slide);}else{Ext.getCmp("Mostrador-mostradorVender").hide(Ext.anims.slide);}
for(i=0;i<carrito.items.length;i++){if(Ext.get("Mostrador-carritoCantidad"+carrito.items[i].productoID+"Text")){continue;}
a=new Ext.form.Text({renderTo:"Mostrador-carritoCantidad"+carrito.items[i].idUnique,id:"Mostrador-carritoCantidad"+carrito.items[i].idUnique+"Text",value:carrito.items[i].cantidad,prodID:carrito.items[i].id_producto,idUnique:carrito.items[i].idUnique,fieldCls:'Mostrador-input',style:{textAlign:'center',width:'100%'},placeHolder:"",listeners:{'focus':function(){this.setValue("");kconf={type:'num',submitText:'Aceptar',callback:function(campo){for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==campo.idUnique){Aplicacion.Mostrador.currentInstance.carrito.items[i].cantidad=parseFloat(campo.getValue());break;}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});b=new Ext.form.Text({renderTo:"Mostrador-carritoPrecio"+carrito.items[i].idUnique,id:"Mostrador-carritoPrecio"+carrito.items[i].idUnique+"Text",value:POS.currencyFormat(carrito.items[i].precio),prodID:carrito.items[i].id_producto,idUnique:carrito.items[i].idUnique,placeHolder:"Precio de Venta",style:{width:'100%'},listeners:{'focus':function(a){this.setValue("");kconf={type:'num',submitText:'Aceptar',callback:function(campo){for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==campo.idUnique){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true"){precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVentaProcesado;}else{precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVenta;}
if(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true"){precioVentaIntersucursal=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursalProcesado;}else{precioVentaIntersucursal=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursal;}
if(!(Aplicacion.Mostrador.currentInstance.carrito.cliente!=null&&Aplicacion.Mostrador.currentInstance.carrito.venta_preferencial.cliente!=null&&Aplicacion.Mostrador.currentInstance.carrito.cliente.id_cliente==Aplicacion.Mostrador.currentInstance.carrito.venta_preferencial.cliente.id_cliente))
{if(parseFloat(campo.getValue())<parseFloat(precioVenta)){Ext.Msg.alert("Mostrador","No puede bajar un precio por debajo del preestablecido.");Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=precioVenta;break;}}
if(venta_intersucursal)
{if(parseFloat(campo.getValue())!=parseFloat(precioVentaIntersucursal))
{Ext.Msg.alert("Mostrador","No puede modificar el precio de un producto en una venta intersucursal.");Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=precioVentaIntersucursal;break;}}
var error=false;for(var j=0;j<Aplicacion.Mostrador.currentInstance.carrito.items.length;j++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==Aplicacion.Mostrador.currentInstance.carrito.items[j].idUnique){continue;}
if(Aplicacion.Mostrador.currentInstance.carrito.items[i].id_producto==Aplicacion.Mostrador.currentInstance.carrito.items[j].id_producto&&Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado==Aplicacion.Mostrador.currentInstance.carrito.items[j].procesado&&parseFloat(campo.getValue())!=Aplicacion.Mostrador.currentInstance.carrito.items[j].precio){descripcion=(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true")?"Limpia":"Original";Ext.Msg.alert("Alerta","Existen 2 procuctos "+Aplicacion.Mostrador.currentInstance.carrito.items[i].descripcion+" "+descripcion+" con diferente precio.");Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=parseFloat(Aplicacion.Mostrador.currentInstance.carrito.items[j].precio)
error=true;break;}}
if(error){break;}
Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=parseFloat(campo.getValue());break;}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});if(carrito.items[i].tratamiento!=null){var habilitar_boton_tratamiento=true;var productoI=inventario.findRecord("productoID",carrito.items[i].id_producto,0,false,true,true);if(parseFloat(productoI.get("existencias"))==0){if(DEBUG){console.log("no hay originales !!");}
carrito.items[i].procesado="true";habilitar_boton_tratamiento=false;}
if(parseFloat(productoI.get("existenciasProcesadas"))==0){if(DEBUG){console.log("no hay procesadas !!");}
carrito.items[i].procesado="false";habilitar_boton_tratamiento=false;}
c=new Ext.form.Select({renderTo:"Mostrador-carritoTratamiento"+carrito.items[i].idUnique,id:"Mostrador-carritoTratamiento"+carrito.items[i].idUnique+"Select",idUnique:carrito.items[i].idUnique,disabled:!habilitar_boton_tratamiento,value:carrito.items[i].procesado,style:{width:'100%'},options:[{text:"Limpia",value:"true"},{text:"Original",value:"false"}],listeners:{"change":function(){if(DEBUG){console.log("OK, cambie de tipo de proceso a ...",this.value);}
for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==this.idUnique){Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=this.value;if(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true"){Aplicacion.Mostrador.currentInstance.carrito.items[i].descuento="0";var found=false;for(var j=0;j<Aplicacion.Mostrador.currentInstance.carrito.items.length;j++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==Aplicacion.Mostrador.currentInstance.carrito.items[j].idUnique){continue;}
if(Aplicacion.Mostrador.currentInstance.carrito.items[i].id_producto==Aplicacion.Mostrador.currentInstance.carrito.items[j].id_producto&&Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado==Aplicacion.Mostrador.currentInstance.carrito.items[j].procesado){Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=parseFloat(Aplicacion.Mostrador.currentInstance.carrito.items[j].precio);found=true;break;}}
if(found){break;}else{if(venta_intersucursal){Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursalProcesado;}else{Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVentaProcesado;}}}else{var found=false;for(var j=0;j<Aplicacion.Mostrador.currentInstance.carrito.items.length;j++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==Aplicacion.Mostrador.currentInstance.carrito.items[j].idUnique){continue;}
if(Aplicacion.Mostrador.currentInstance.carrito.items[i].id_producto==Aplicacion.Mostrador.currentInstance.carrito.items[j].id_producto&&Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado==Aplicacion.Mostrador.currentInstance.carrito.items[j].procesado){Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=parseFloat(Aplicacion.Mostrador.currentInstance.carrito.items[j].precio);Aplicacion.Mostrador.currentInstance.carrito.items[i].descuento=parseFloat(Aplicacion.Mostrador.currentInstance.carrito.items[j].descuento);found=true;break;}}
if(found){break;}
else{if(venta_intersucursal){Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursal;}
else{Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVenta;}}}
if(DEBUG){console.log("El producto "+this.idUnique+" esta  procesado ?"+Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado);}}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}}});d=new Ext.form.Text({renderTo:"Mostrador-carritoDescuento"+carrito.items[i].idUnique,id:"Mostrador-carritoDescuento"+carrito.items[i].idUnique+"Text",value:carrito.items[i].descuento,prodID:carrito.items[i].id_producto,idUnique:carrito.items[i].idUnique,disabled:carrito.items[i].procesado=="true"?true:false,style:{width:'100%'},listeners:{'focus':function(a){this.setValue("");kconf={type:'num',submitText:'Cambiar',callback:function(campo){for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==campo.idUnique){var error=false;for(var j=0;j<Aplicacion.Mostrador.currentInstance.carrito.items.length;j++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==Aplicacion.Mostrador.currentInstance.carrito.items[j].idUnique){continue;}
if(Aplicacion.Mostrador.currentInstance.carrito.items[i].id_producto==Aplicacion.Mostrador.currentInstance.carrito.items[j].id_producto&&Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado==Aplicacion.Mostrador.currentInstance.carrito.items[j].procesado&&parseFloat(campo.getValue())!=Aplicacion.Mostrador.currentInstance.carrito.items[j].descuento){descripcion=(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true")?"Limpia":"Original";Ext.Msg.alert("Alerta","Existen 2 procuctos "+Aplicacion.Mostrador.currentInstance.carrito.items[i].descripcion+" "+descripcion+" con diferente descuento.");Aplicacion.Mostrador.currentInstance.carrito.items[i].descuento=parseFloat(Aplicacion.Mostrador.currentInstance.carrito.items[j].descuento)
error=true;break;}}
if(error){break;}
var value=campo.getValue();if(!isNaN(value)&&value>=0&&value<carrito.items[i].cantidad){carrito.items[i].descuento=value;}else{campo.setValue("0");carrito.items[i].descuento="0";}
break;}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});}
e=new Ext.form.Text({renderTo:"Mostrador-carritoSubtotal"+carrito.items[i].idUnique,id:"Mostrador-carritoSubtotal"+carrito.items[i].idUnique+"Text",value:POS.currencyFormat((carrito.items[i].cantidad-carrito.items[i].descuento)*carrito.items[i].precio),prodID:carrito.items[i].id_producto,idUnique:carrito.items[i].idUnique,fieldCls:'Mostrador-input',style:{textAlign:'center',width:'100%'},placeHolder:"",listeners:{'focus':function(){this.setValue("");kconf={type:'num',submitText:'Aceptar',callback:function(campo){for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++){if(Aplicacion.Mostrador.currentInstance.carrito.items[i].idUnique==campo.idUnique){carrito.items[i].cantidad=(parseFloat(campo.getValue())/carrito.items[i].precio)+carrito.items[i].descuento;if(DEBUG){console.log("cantidad : ",carrito.items[i].cantidad," valor : ",parseFloat(campo.getValue())," precio : ",carrito.items[i].precio," descuento : ",carrito.items[i].descuento);}
break;}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});}};Aplicacion.Mostrador.prototype.agregarProducto=function()
{val=Aplicacion.Mostrador.currentInstance.mostradorPanel.getDockedComponent(0).getComponent(0).getValue();Aplicacion.Mostrador.currentInstance.mostradorPanel.getDockedComponent(0).getComponent(0).setValue("");Aplicacion.Mostrador.currentInstance.agregarProductoPorID(val);};Aplicacion.Mostrador.prototype.agregarProductoPorID=function(id)
{inventario=Aplicacion.Inventario.currentInstance.inventarioListaStore;if(DEBUG){console.log("buscando el producto"+id);console.log("Aplicacion.Inventario.currentInstance.inventarioListaStore es : "+Aplicacion.Inventario.currentInstance.inventarioListaStore);}
res=inventario.findRecord("productoID",id,0,false,true,true);if(res===null){Ext.Msg.alert("Mostrador","Este producto no existe");return;}
if(DEBUG){console.log("Agregando el producto "+id+" al carrito.",res);}
for(var a=0,found=false,incidencias=0;a<this.carrito.items.length;a++)
{if(this.carrito.items[a].id_producto==id)
{incidencias++;if(this.carrito.items[a].tratamiento==""){found=true;this.carrito.items[a].cantidad++;break;}
if(incidencias>1){Ext.Msg.alert("Mostrador","El producto "+res.data.descripcion+" ya existe en el carrito.");found=true;break;}}}
var venta_intersucursal=false;if(carrito.cliente!=null&&carrito.cliente.id_cliente<0){venta_intersucursal=true;if(DEBUG){console.log("venta intesucursal activadan al insertar el producto");}}
if(!found)
{this.carrito.items.push({descripcion:res.data.descripcion,existencias:res.data.existencias,existencias_procesadas:res.data.existenciasProcesadas,tratamiento:res.data.tratamiento,precioVenta:res.data.precioVenta,precioVentaProcesado:res.data.precioVentaProcesado,precioIntersucursal:res.data.precioIntersucursal,precioIntersucursalProcesado:res.data.precioIntersucursalProcesado,precio:venta_intersucursal?res.data.tratamiento!=null?res.data.precioIntersucursalProcesado:res.data.precioIntersucursalProcesado:res.data.tratamiento!=null?res.data.precioVentaProcesado:res.data.precioVenta,id_producto:res.data.productoID,escala:res.data.medida,procesado:res.data.tratamiento!=null?"true":"false",cantidad:1,idUnique:res.data.productoID+"_"+Aplicacion.Mostrador.currentInstance.uniqueIndex,descuento:"0",input_box_rendered:false});Aplicacion.Mostrador.currentInstance.uniqueIndex++;}
this.refrescarMostrador();};Aplicacion.Mostrador.prototype.uniqueIndex=0;Aplicacion.Mostrador.prototype.quitarDelCarrito=function(id)
{if(DEBUG){console.log("Removiendo del carrito.");}
carrito=Aplicacion.Mostrador.currentInstance.carrito;for(var i=carrito.items.length-1;i>=0;i--){if(carrito.items[i].idUnique==id){carrito.items.splice(i,1);break;}}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();};Aplicacion.Mostrador.prototype.mostradorPanel=null;Aplicacion.Mostrador.prototype.mostradorPanelCreator=function(){var productos=[{xtype:'textfield',placeHolder:"Agregar Producto",listeners:{'focus':function(){kconf={type:'num',submitText:'Agregar',callback:Aplicacion.Mostrador.currentInstance.agregarProducto};POS.Keyboard.Keyboard(this,kconf);}}},{xtype:"button",text:"Buscar",handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Inventario.currentInstance.listaInventarioPanel,'fade');}}];var venta=[{text:'Cancelar Venta',ui:'action',handler:this.cancelarVenta},{xtype:'segmentedbutton',id:'Mostrador-tipoCliente',allowDepress:false,items:[{text:'Caja Comun',pressed:true,handler:this.setCajaComun},{text:'Cliente',handler:this.buscarClienteFormShow,badgeText:""}]},{id:'Mostrador-mostradorVender',hidden:true,text:'Vender',ui:'forward',handler:this.doVentaPanelShow}];productos.push({xtype:'spacer'});var dockedItems=[new Ext.Toolbar({ui:'light',dock:'bottom',items:productos.concat(venta)})];this.mostradorPanel=new Ext.Panel({listeners:{"show":this.refrescarMostrador},floating:false,ui:"dark",modal:false,cls:"Tabla",items:[{id:'MostradorHtmlPanel',html:null}],scroll:'none',dockedItems:dockedItems});};Aplicacion.Mostrador.prototype.buscarClienteForm=null;Aplicacion.Mostrador.prototype.clienteSeleccionado=function(cliente)
{if(DEBUG){console.log("cliente seleccionado",cliente);}
this.buscarClienteFormShow();Ext.getCmp("Mostrador-tipoCliente").getComponent(1).setBadge(cliente.razon_social);Aplicacion.Mostrador.currentInstance.carrito.cliente=cliente;if(cliente.id_cliente<0)
{if(DEBUG){console.log("Seleccionamos una sucursal como cliente : restaurando precios intersucursal");}
Aplicacion.Mostrador.currentInstance.restaurarPreciosIntersucursal();}
else
{if(DEBUG){console.log("Seleccionamos un cliente normal : restaurando precios originales");}
Aplicacion.Mostrador.currentInstance.restaurarPreciosOriginales();}};Aplicacion.Mostrador.prototype.clientePreferencialSeleccionado=function(cliente)
{if(DEBUG){console.log("cliente preferencial seleccionado",cliente);}
Ext.getCmp("Mostrador-tipoCliente").getComponent(1).setBadge(cliente.razon_social);Aplicacion.Mostrador.currentInstance.carrito.cliente=cliente;Aplicacion.Mostrador.currentInstance.refrescarMostrador()};Aplicacion.Mostrador.prototype.setCajaComun=function()
{if(Ext.getCmp('Mostrador-tipoCliente').getPressed()){Ext.getCmp('Mostrador-tipoCliente').setPressed(Ext.getCmp('Mostrador-tipoCliente').getPressed());}
Ext.getCmp("Mostrador-tipoCliente").getComponent(1).setBadge();Ext.getCmp('Mostrador-tipoCliente').setPressed(0);Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="contado";Aplicacion.Mostrador.currentInstance.carrito.cliente=null;Aplicacion.Mostrador.currentInstance.restaurarPreciosOriginales();};Aplicacion.Mostrador.prototype.buscarClienteFormCreator=function()
{var dockedCancelar={xtype:'button',text:'Cancelar',handler:function(){Aplicacion.Mostrador.currentInstance.setCajaComun();Aplicacion.Mostrador.currentInstance.buscarClienteFormShow();}};var dockedItems={xtype:'toolbar',dock:'bottom',items:[dockedCancelar,{xtype:'spacer'}]};var formBase={autoRender:true,style:{zIndex:'10000 !important'},listeners:{'show':function(){if(!Aplicacion.Mostrador.currentInstance.buscarClienteForm.getComponent(0).getStore())
{Aplicacion.Mostrador.currentInstance.buscarClienteForm.getComponent(0).bindStore(Aplicacion.Clientes.currentInstance.listaDeClientesStore);}}},floating:true,modal:true,centered:true,hideOnMaskTap:false,height:585,width:680,items:[{width:'100%',height:'100%',xtype:'list',store:Aplicacion.Clientes?Aplicacion.Clientes.currentInstance.listaDeClientesStore:null,itemTpl:'<div class="listaDeClientesCliente"><strong>{razon_social}</strong> {rfc}</div>',grouped:true,indexBar:true,listeners:{"selectionchange":function(view,nodos,c){if(nodos.length>0){Aplicacion.Mostrador.currentInstance.clienteSeleccionado(nodos[0].data);}
view.deselectAll();}}}],dockedItems:dockedItems};if(DEBUG){console.log("creando la forma de buscar clientes");}
this.buscarClienteForm=new Ext.Panel(formBase);this.buscarClienteForm.setVisible(false);};Aplicacion.Mostrador.prototype.buscarClienteFormShow=function()
{if(Aplicacion.Mostrador.currentInstance.buscarClienteForm){Aplicacion.Mostrador.currentInstance.buscarClienteForm.setVisible(!Aplicacion.Mostrador.currentInstance.buscarClienteForm.isVisible());}else{Aplicacion.Mostrador.currentInstance.buscarClienteFormCreator();Aplicacion.Mostrador.currentInstance.buscarClienteFormShow();}};Aplicacion.Mostrador.prototype.restaurarPreciosOriginales=function()
{if(DEBUG){console.log("restaurando precios originales");}
for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++)
{if(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true"){precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVentaProcesado;}else{precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioVenta;}
Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=precioVenta;}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}
Aplicacion.Mostrador.prototype.restaurarPreciosIntersucursal=function()
{if(DEBUG){console.log("restaurando precios intersucursales");}
for(var i=0;i<Aplicacion.Mostrador.currentInstance.carrito.items.length;i++)
{if(Aplicacion.Mostrador.currentInstance.carrito.items[i].procesado=="true"){precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursalProcesado;}else{precioVenta=Aplicacion.Mostrador.currentInstance.carrito.items[i].precioIntersucursal;}
Aplicacion.Mostrador.currentInstance.carrito.items[i].precio=precioVenta;}
Aplicacion.Mostrador.currentInstance.refrescarMostrador();}
Aplicacion.Mostrador.prototype.finishedPanel=null;Aplicacion.Mostrador.prototype.finishedPanelShow=function()
{this.finishedPanelUpdater();sink.Main.ui.setActiveItem(Aplicacion.Mostrador.currentInstance.finishedPanel,'fade');};Aplicacion.Mostrador.prototype.finishedPanelUpdater=function()
{carrito=Aplicacion.Mostrador.currentInstance.carrito;carrito.sucursal=POS.infoSucursal;carrito.descuento=parseFloat(carrito.descuento);carrito.ticket="venta_cliente";for(i=0;i<POS.documentos.length;i++){if(POS.documentos[i].documento==carrito.ticket){carrito.impresora=POS.documentos[i].impresora;break;}}
carrito.leyendasTicket=POS.leyendasTicket;if(DEBUG){console.log("carrito : ",carrito);console.log("carrito.items : ",carrito.items);}
html="";html+="<table class='Mostrador-ThankYou'>";html+=" <tr>";html+="  <td ><img width = 200px height = 200px src='../media/Receipt128.png'></td>";html+="  <td></td>";html+=" </tr>";if(carrito.tipo_venta!="credito"){html+=" <tr>";html+="  <td>Su cambio: <b>"+POS.currencyFormat(parseFloat(Ext.getCmp("Mostrador-doNuevaVentaImporte").getValue())-parseFloat(carrito.total))+"</b></td>";html+="  <td></td>";html+=" </tr>";}
html+="</table>";hora=new Date()
var dia=hora.getDate();var mes=hora.getMonth();var anio=hora.getFullYear();horas=hora.getHours()
minutos=hora.getMinutes()
segundos=hora.getSeconds()
if(mes<=9)mes="0"+mes
if(horas>=12)tiempo=" p.m."
else tiempo=" a.m."
if(horas>12)horas-=12
if(horas==0)horas=12
if(minutos<=9)minutos="0"+minutos
if(segundos<=9)segundos="0"+segundos
var PRINT_VIA_JAVA_CLIENT=true;if(PRINT_VIA_JAVA_CLIENT)
{POS.ajaxToClient({module:"Printer",args:carrito,success:function(r){if(DEBUG){console.log("ticket printing responded",r);}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});}
this.finishedPanel.update(html);Ext.getCmp("Mostrador-mostradorVender").hide(Ext.anims.slide);action="sink.Main.ui.setActiveItem( Aplicacion.Mostrador.currentInstance.mostradorPanel , 'fade');";setTimeout(action,4000);};Aplicacion.Mostrador.prototype.finishedPanelCreator=function()
{this.finishedPanel=new Ext.Panel({html:""});};Aplicacion.Mostrador.prototype.doVenta=function()
{carrito=Aplicacion.Mostrador.currentInstance.carrito;if(carrito.tipo_venta=='contado'){if(DEBUG){console.log("revisando venta a contado...");}
pagado=Ext.getCmp("Mostrador-doNuevaVentaImporte").getValue();if((pagado.length===0)||(parseFloat(pagado)<parseFloat(carrito.total))){Ext.Msg.alert("Mostrador","Verifique al cantidad del importe.");return;}
if(Ext.getCmp('Mostrador-doNuevaVentaFacturar').getValue()==1){if(Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').getValue()==1){var str=Ext.getCmp('Mostrador-doNuevaVentaConcepto').getValue()
str=str.replace(/^\s*|\s*$/g,"");if(!(str.length>=5)){Ext.Msg.alert("Mostrador","El concepto de la factura generica es demaciado corta.");return;}else{Aplicacion.Mostrador.currentInstance.carrito.facturaConcepto=Ext.getCmp('Mostrador-doNuevaVentaConcepto').getValue();}}}
this.carrito.pagado=parseFloat(pagado);this.carrito.fecha=new Date();this.vender();}else{if(DEBUG){console.log("revisando venta a credito...");}
this.vender();}};Aplicacion.Mostrador.thisPosSaleId=0;Aplicacion.Mostrador.prototype.offlineVender=function()
{var carrito=Aplicacion.Mostrador.currentInstance.carrito;if(DEBUG){console.warn("-------- Venta offline !!! ---------");console.log("Aplicacion.Mostrador.thisPosSaleId=",Aplicacion.Mostrador.thisPosSaleId);console.log("Aplicacion.Mostrador.currentInstance.carrito=",Aplicacion.Mostrador.currentInstance.carrito);}
var this_sale=new Ventas({id_venta:Aplicacion.Mostrador.thisPosSaleId,id_venta_equipo:Aplicacion.Mostrador.thisPosSaleId,id_equipo:1,id_cliente:carrito.cliente==null?null:carrito.cliente.id_cliente,tipo_venta:carrito.tipo_venta,tipo_pago:carrito.tipo_pago,fecha:new Date(),subtotal:carrito.subtotal,iva:carrito.iva,descuento:0,total:carrito.total,id_sucursal:null,id_usuario:null,pagado:carrito.pagado,cancelada:null,ip:null,liquidada:null});this_sale.save(function(saved_sale){if(DEBUG)console.log("Back from saving offline sale sale !",saved_sale);var detalles=Aplicacion.Mostrador.currentInstance.carrito.items,l=Aplicacion.Mostrador.currentInstance.carrito.items.length;if(DEBUG)console.log("Ahora intentare guardar los "+l+" detalles.");for(var d=0,td=null;d<detalles.length;d++){if(DEBUG)console.log("guardando detalle...");var qty_dirty="0",qty_proc="0";if(detalles[d].procesado=="true"){qty_proc=detalles[d].cantidad;}else{qty_dirty=detalles[d].cantidad;}
td=new DetalleVenta({id_venta:saved_sale.getIdVenta(),id_producto:detalles[d].id_producto,cantidad:qty_dirty,cantidad_procesada:qty_proc,precio:detalles[d].precioVenta,precio_procesada:detalles[d].precioVentaProcesado,descuento:detalles[d].descuento});td.save(function(){if(DEBUG){console.log("termine de guardar el detalle de venta");}});Aplicacion.Mostrador.currentInstance.cancelarVenta();};});Aplicacion.Mostrador.currentInstance.finishedPanelShow();}
Aplicacion.Mostrador.prototype.vender=function()
{carrito=Aplicacion.Mostrador.currentInstance.carrito;if(DEBUG){console.log(" ----- Enviando venta :",Aplicacion.Mostrador.currentInstance.carrito," ----------");}
Aplicacion.Mostrador.thisPosSaleId++;if(POS.A.failure)
{if(carrito.factura)
{Ext.Msg.alert("Error al Generar la Factura","En este momento usted tiene problemas de conexión, solicite la factura mas tarde.");}
return Aplicacion.Mostrador.currentInstance.offlineVender();}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:100,payload:Ext.util.JSON.encode(Aplicacion.Mostrador.currentInstance.carrito)},success:function(response,opts){try{venta=Ext.util.JSON.decode(response.responseText);}catch(e){if(carrito.factura)
{Ext.Msg.alert("Error al Generar la Factura","En este momento usted tiene problemas de conexión, solicite la factura mas tarde.");}
POS.error(response,e);Aplicacion.Mostrador.currentInstance.offlineVender();return;}
if(!venta.success){if(DEBUG){console.log("resultado de la venta sin exito ",venta);}
POS.error(venta);if(carrito.factura)
{Ext.Msg.alert("Error al Generar la Factura","En este momento usted tiene problemas de conexión, solicite la factura mas tarde.");}
Aplicacion.Mostrador.currentInstance.offlineVender();return;}
if(DEBUG){console.log("resultado de la venta exitosa ",venta);}
if(carrito.cliente!=null&&carrito.venta_preferencial.cliente!=null&&carrito.cliente.id_cliente==carrito.venta_preferencial.cliente.id_cliente)
{Aplicacion.Autorizaciones.currentInstance.finalizarAutorizacionVentaPreferencial();}
Aplicacion.Mostrador.currentInstance.carrito.id_venta=venta.id_venta;Aplicacion.Mostrador.currentInstance.carrito.empleado=venta.empleado;Aplicacion.Inventario.currentInstance.cargarInventario();if(Aplicacion.Mostrador.currentInstance.carrito.cliente!==null)
{Aplicacion.Clientes.currentInstance.listaDeClientesLoad();}
if(carrito.factura)
{var factura_generica=null;if(carrito.facturaGenerica==1){factura_generica={id_producto:'GEN01',descripcion:carrito.facturaConcepto,unidad:'unidad'};}
Ext.getBody().mask('Solicitando Factura ...','x-mask-loading',true);Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:1200,factura_generica:Ext.util.JSON.encode(factura_generica),id_venta:carrito.id_venta},success:function(response,opts){var factura=null;try{factura=Ext.util.JSON.decode(response.responseText);}catch(e){Ext.getBody().unmask();Ext.Msg.alert("Error Factura Cliente","Error al momento de solicitar la factura : "+e+".");POS.error(factura,e);return;}
if(!factura.success){if(DEBUG){console.log("resultado de la factura sin exito ",factura);}
Ext.getBody().unmask();Ext.Msg.alert("Error Factura Cliente","Error al momento de solicitar la factura : "+factura.reason+".");POS.error(factura);return;}
Ext.getBody().unmask();if(DEBUG){console.log("resultado de la factura exitosa ",factura);}
Ext.Msg.alert("Factura Cliente","Se ha realizado correctamente la factura!!");window.open('http://pos.caffeina.mx/proxy.php?action=1308&id_venta='+carrito.id_venta);},failure:function(response){if(DEBUG){console.log("ya regrese del ajax, pero no habia conexion, estoy en el failure... no se realizo la factura");}
Ext.getBody().unmask();Ext.Msg.alert("Error Factura Cliente","Error al Generar la Factura, al parecer esta experimentando problemas de conexion.");POS.error(response);}});}
Aplicacion.Mostrador.currentInstance.finishedPanelShow();Aplicacion.Mostrador.currentInstance.cancelarVenta();},failure:function(response){if(DEBUG){console.log("ya regrese del ajax, pero no habia conexion, estoy en el failure... hare una venta offline");}
POS.error(response);return Aplicacion.Mostrador.currentInstance.offlineVender();}});};Aplicacion.Mostrador.prototype.doVentaPanel=null;Aplicacion.Mostrador.prototype.doNuevaVentaPanel=null;Aplicacion.Mostrador.prototype.doVentaPanelShow=function()
{carrito=Aplicacion.Mostrador.currentInstance.carrito;for(a=0;a<carrito.items.length;a++){if(DEBUG){console.log("Revisando... "+carrito.items[a].descripcion);}
if(isNaN(carrito.items[a].cantidad)||carrito.items[a].cantidad==0){Ext.Msg.alert("Mostrador","Porfavor revise la cantidad de "+carrito.items[a].descripcion);return;}}
sink.Main.ui.setActiveItem(Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel,'slide');};Aplicacion.Mostrador.prototype.setTipoVenta=function(tipo_venta){if(tipo_venta=="contado"){Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="contado";Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel.getComponent(1).setActiveItem(1,Ext.anims.slide);Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setValue("");Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setValue("");Ext.getCmp('Mostrador-doNuevaVentaImporte').show();}
if(tipo_venta=="credito"){Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="credito";Ext.getCmp('Mostrador-doNuevaVentaFacturar').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(false);Aplicacion.Mostrador.currentInstance.carrito.tipo_pago=null;Ext.getCmp('Mostrador-doNuevaVentaImporte').hide();if(Aplicacion.Mostrador.currentInstance.carrito.cliente!=null&&Aplicacion.Mostrador.currentInstance.carrito.cliente.id_cliente<0){Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').hide(Ext.anims.slide);Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').hide(Ext.anims.slide);Ext.getCmp('Mostrador-doNuevaVenta-Menu-Efectivo').hide();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Cheque').hide();}else{}
Aplicacion.Mostrador.currentInstance.doVenta();}};Aplicacion.Mostrador.prototype.setTipoPago=function(tipoPago){switch(tipoPago){case'efectivo':Aplicacion.Mostrador.currentInstance.carrito.tipo_pago="efectivo";if(Aplicacion.Mostrador.currentInstance.carrito.cliente!=null){Ext.getCmp('Mostrador-doNuevaVentaFacturar').setVisible(true);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(false);}
Ext.getCmp('Mostrador-doNuevaVentaImporte').setValue("");break;case'cheque':Aplicacion.Mostrador.currentInstance.carrito.tipo_pago="cheque";if(Aplicacion.Mostrador.currentInstance.carrito.cliente!=null){Ext.getCmp('Mostrador-doNuevaVentaFacturar').setVisible(true);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(false);}
Ext.getCmp('Mostrador-doNuevaVentaImporte').setValue(POS.currencyFormat(this.carrito.total));Aplicacion.Mostrador.currentInstance.doVenta();break;default:Aplicacion.Mostrador.currentInstance.carrito.tipo_pago=null;Ext.Msg.alert("Mostraror","Error, porfavor intente de nuevo.");}
Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel.getComponent(1).setActiveItem(2,Ext.anims.slide);};Aplicacion.Mostrador.prototype.doNuevaVentaPanelUpdater=function()
{if(DEBUG){console.log("Haciendo update en el formulario de la venta",this.carrito);}
Ext.getCmp('Mostrador-doNuevaVentaImporte').setValue("");Ext.getCmp('Mostrador-doNuevaVentaCliente').setValue("Caja comun");Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setValue("");Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setValue("");Ext.getCmp('Mostrador-doNuevaVentaDescuento').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaDescuento').setValue("");if(Ext.getCmp('Mostrador-doNuevaVentaFacturar').rendered){Ext.getCmp('Mostrador-doNuevaVentaFacturar').reset();Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').reset();}
Ext.getCmp('Mostrador-doNuevaVentaFacturar').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaImporte').show();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Efectivo').show();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Cheque').show();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Contado').show();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Credito').show();subtotal=0;total=0;for(var i=0;i<this.carrito.items.length;i++){subtotal+=(this.carrito.items[i].precio*(this.carrito.items[i].cantidad-this.carrito.items[i].descuento));}
if(this.carrito.cliente===null){total=subtotal;Aplicacion.Mostrador.currentInstance.carrito.factura=false;Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="contado";Ext.getCmp('Mostrador-doNuevaVenta-Menu-Credito').hide();Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel.getComponent(1).setActiveItem(1,Ext.anims.slide);}else{Ext.getCmp('Mostrador-doNuevaVentaCliente').setValue(this.carrito.cliente.razon_social+"  "+this.carrito.cliente.rfc);if(this.carrito.cliente.limite_credito>0){Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setValue(POS.currencyFormat(this.carrito.cliente.limite_credito));Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setValue(POS.currencyFormat(this.carrito.cliente.credito_restante));}else{Ext.getCmp('Mostrador-doNuevaVentaClienteCreditoRestante').setVisible(false);Ext.getCmp('Mostrador-doNuevaVentaClienteCredito').setVisible(false);Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="contado";}
if(this.carrito.cliente.descuento>0){Ext.getCmp('Mostrador-doNuevaVentaDescuento').setVisible(true);Ext.getCmp('Mostrador-doNuevaVentaDescuento').setValue(POS.currencyFormat(subtotal*(this.carrito.cliente.descuento/100))+" ( "+this.carrito.cliente.descuento+"% )");}
else{Ext.getCmp('Mostrador-doNuevaVentaDescuento').setVisible(false);}
total=subtotal-(subtotal*(this.carrito.cliente.descuento/100));if(total<=this.carrito.cliente.credito_restante){Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel.getComponent(1).setActiveItem(0);Ext.getCmp('Mostrador-doNuevaVenta-Menu-Credito').show();}else{Aplicacion.Mostrador.currentInstance.carrito.tipo_venta="contado";Ext.getCmp('Mostrador-doNuevaVenta-Menu-Credito').hide();Aplicacion.Mostrador.currentInstance.doNuevaVentaPanel.getComponent(1).setActiveItem(1,Ext.anims.slide);}
if(this.carrito.cliente!=null&&this.carrito.cliente.id_cliente<0){Ext.getCmp('Mostrador-doNuevaVenta-Menu-Contado').hide();Ext.getCmp('Mostrador-doNuevaVenta-Menu-Credito').show();Aplicacion.Mostrador.currentInstance.setTipoVenta("credito");Ext.getCmp('Mostrador-doNuevaVentaForm-Carousel').removeAll(false);Ext.getCmp('Mostrador-doNuevaVentaForm-Carousel').insert(0,Ext.getCmp('Mostrador-doNuevaVentaCobrar'));}}
Ext.getCmp('Mostrador-doNuevaVentaSubTotal').setValue(POS.currencyFormat(subtotal));Ext.getCmp('Mostrador-doNuevaVentaTotal').setValue(POS.currencyFormat(total));this.carrito.subtotal=subtotal;this.carrito.total=total;};Aplicacion.Mostrador.prototype.doNuevaVentaPanelCreator=function(){dockedCancelar={xtype:'button',text:'Regresar',ui:'back',handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Mostrador.currentInstance.mostradorPanel,'slide');}};dockedVender={xtype:'button',text:'Vender',ui:'confirm',handler:function(){Aplicacion.Mostrador.currentInstance.doVenta();}};dockedItems={xtype:'toolbar',dock:'bottom',items:[dockedCancelar,{xtype:'spacer'}]};this.doNuevaVentaPanel=new Ext.Panel({listeners:{"show":function(){Aplicacion.Mostrador.currentInstance.doNuevaVentaPanelUpdater();}},cls:'cards',dockedItems:dockedItems,layout:{type:'vbox',align:'stretch'},defaults:{flex:1},items:[{xtype:'fieldset',bodyPadding:10,id:'Mostrador-doNuevaVentaForm',items:[new Ext.form.Text({label:'Cliente',id:'Mostrador-doNuevaVentaCliente'}),new Ext.form.Text({label:'Limite de Credito',id:'Mostrador-doNuevaVentaClienteCredito',hidden:true}),new Ext.form.Text({label:'Credito restante',id:'Mostrador-doNuevaVentaClienteCreditoRestante',hidden:true}),new Ext.form.Toggle({listeners:{"change":function(a,b,newVal,oldVal){if(newVal==1){Ext.getCmp('Mostrador-doNuevaVentaConcepto').setValue("");Ext.getCmp('Mostrador-doNuevaVentaConcepto').setVisible(true);Aplicacion.Mostrador.currentInstance.carrito.facturaGenerica=1;}else{Ext.getCmp('Mostrador-doNuevaVentaConcepto').setValue("");Ext.getCmp('Mostrador-doNuevaVentaConcepto').setVisible(false);Aplicacion.Mostrador.currentInstance.carrito.facturaGenerica=0;}}},id:'Mostrador-doNuevaVentaFacturaGenerica',hidden:true,label:'Active para factura generica'}),new Ext.form.Text({label:'Concepto',id:'Mostrador-doNuevaVentaConcepto',hidden:true,listeners:{'focus':function(){kconf={type:'alfanum',submitText:'Aceptar'};POS.Keyboard.Keyboard(this,kconf);}}}),new Ext.form.Toggle({listeners:{"change":function(a,b,newVal,oldVal){if(newVal==1){Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setValue(0);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(true);Aplicacion.Mostrador.currentInstance.carrito.factura=1;}else{Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setValue(0);Ext.getCmp('Mostrador-doNuevaVentaFacturaGenerica').setVisible(false);Aplicacion.Mostrador.currentInstance.carrito.factura=0;}
Aplicacion.Mostrador.currentInstance.carrito.factura=newVal==1;}},id:'Mostrador-doNuevaVentaFacturar',hidden:true,label:'Facturar'}),new Ext.form.Text({label:'Subtotal',id:'Mostrador-doNuevaVentaSubTotal'}),new Ext.form.Text({label:'Descuento',id:'Mostrador-doNuevaVentaDescuento'}),new Ext.form.Text({label:'Total',id:'Mostrador-doNuevaVentaTotal'})]},{id:'Mostrador-doNuevaVentaForm-Carousel',xtype:'carousel',direction:'vertical',listeners:{"cardswitch":function(){}},activeItem:1,indicator:true,items:[{layout:'hbox',style:{width:'100%',marginLeft:'25%'},items:[{id:'Mostrador-doNuevaVenta-Menu-Contado',style:{width:'190px !important',height:'100px !important'},html:'<img onClick="Aplicacion.Mostrador.currentInstance.setTipoVenta(\'contado\')" src="../media/venta_contado.png"  />'
+'<br>Venta a contado'},{id:'Mostrador-doNuevaVenta-Menu-Credito',style:{width:'190px !important',height:'100px !important',marginLeft:'100px'},html:'<img onClick="Aplicacion.Mostrador.currentInstance.setTipoVenta(\'credito\')" src="../media/venta_credito.png"  />'
+'<br>Venta a credito'}]},{id:'Mostrador-doNuevaVentaForm-TipoPago',layout:'hbox',style:{width:'100%',marginLeft:'25%'},items:[{id:'Mostrador-doNuevaVenta-Menu-Efectivo',style:{width:'190px !important',height:'100px !important'},html:'<img  onClick="Aplicacion.Mostrador.currentInstance.setTipoPago(\'efectivo\')" src="../media/pago_efectivo.png"  />'
+'<br>Efectivo'},{id:'Mostrador-doNuevaVenta-Menu-Cheque',style:{width:'190px !important',height:'100px !important',marginLeft:'100px'},html:'<img  onClick="Aplicacion.Mostrador.currentInstance.setTipoPago(\'cheque\')" src="../media/pago_cheque.png"  />'
+'<br>Cheque'}]},new Ext.form.FormPanel({style:{width:'100% !important'},id:"Mostrador-doNuevaVentaCobrar",items:[new Ext.form.Text({label:'Importe',id:'Mostrador-doNuevaVentaImporte',listeners:{"focus":function(){kconf={type:'num',submitText:'Cobrar',callback:function(campo){Aplicacion.Mostrador.currentInstance.doVenta();}};POS.Keyboard.Keyboard(Ext.getCmp('Mostrador-doNuevaVentaImporte'),kconf);}}})]})]}]});};POS.Apps.push(new Aplicacion.Mostrador());Aplicacion.Salir=function(){return this._init();}
Aplicacion.Salir.prototype._init=function(){if(DEBUG){console.log("app Salir: construyendo");}
Aplicacion.Salir.currentInstance=this;return this;};Aplicacion.Salir.prototype.getConfig=function(){return{text:'Salir',cls:'launchscreen',leaf:true,card:new Ext.Panel({layout:{type:'vbox',pack:'center',align:'stretch'},defaults:{xtype:'button',cls:'demobtn'},items:[{text:'Salir del punto de venta',handler:function(){Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:2002},success:function(response,opts){window.location=".";},failure:function(response){POS.error(response);}});}}]})};};POS.Apps.push(new Aplicacion.Salir());Aplicacion.ComprasMostrador=function()
{return this._init();};Aplicacion.ComprasMostrador.bascula={basculas:[{puerto:"COM1",desc:"CHICA",read_next:25,discard_first:0},{puerto:"COM4",desc:"GRANDE",read_next:14,discard_first:0}],bascula_actual:1,is_ok:false,time_out:550,running:false,cambiar_bascula:function(){if((Aplicacion.ComprasMostrador.bascula.bascula_actual+1)>=Aplicacion.ComprasMostrador.bascula.basculas.length)
Aplicacion.ComprasMostrador.bascula.bascula_actual=0;else
Aplicacion.ComprasMostrador.bascula.bascula_actual++;if(DEBUG){console.log("Cambiand de bascula a :"+Aplicacion.ComprasMostrador.bascula.bascula_actual);}
Ext.get("display-bascula").update("BASCULA: "+Aplicacion.ComprasMostrador.bascula.basculas[Aplicacion.ComprasMostrador.bascula.bascula_actual].desc);},enviar_comando:function(c){if(Aplicacion.ComprasMostrador.bascula.running===false)return;POS.ajaxToClient({module:"bascula",raw_args:{send_command:c,port:Aplicacion.ComprasMostrador.bascula.basculas[Aplicacion.ComprasMostrador.bascula.bascula_actual].puerto},success:function(r){},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});},check_now:function(){if(Aplicacion.ComprasMostrador.bascula.running===false)return;POS.ajaxToClient({module:"bascula",raw_args:{send_command:'P',discar_first:Aplicacion.ComprasMostrador.bascula.basculas[Aplicacion.ComprasMostrador.bascula.bascula_actual].discard_first,read_next:Aplicacion.ComprasMostrador.bascula.basculas[Aplicacion.ComprasMostrador.bascula.bascula_actual].read_next,port:Aplicacion.ComprasMostrador.bascula.basculas[Aplicacion.ComprasMostrador.bascula.bascula_actual].puerto},success:function(r){if(DEBUG)
console.log("la erre",r);trimmed=r.reading.replace(/^\s+|\s+$/g,"");Ext.get('led_display').update(trimmed);setTimeout("Aplicacion.ComprasMostrador.bascula.check_now(  )",Aplicacion.ComprasMostrador.bascula.time_out);},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});}}
Aplicacion.ComprasMostrador.prototype._init=function()
{if(DEBUG){console.log("Mostrador: construyendo");}
this.mostradorPanelCreator();this.buscarClienteFormCreator();this.finishedPanelCreator();Aplicacion.ComprasMostrador.currentInstance=this;return this;};Aplicacion.ComprasMostrador.prototype.getConfig=function(){return{text:'Compras Mostrador',cls:'launchscreen',card:this.mostradorPanel,leaf:true};};Aplicacion.ComprasMostrador.prototype.carritoCompras={tipo_venta:null,items:[],cliente:null,venta_preferencial:{cliente:null,id_autorizacion:null},factura:false,tipo_pago:null};Aplicacion.ComprasMostrador.prototype.cancelarCompra=function()
{if(DEBUG){console.log("------cancelando compra------");}
Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items=[];Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();Aplicacion.ComprasMostrador.currentInstance.setCajaComun();};Aplicacion.ComprasMostrador.prototype.carritoComprasCambiarCantidad=function(id,qty,forceNewValue)
{var carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items;for(var i=carritoCompras.length-1;i>=0;i--){if(carritoCompras[i].idUnique==id){if(forceNewValue){carritoCompras[i].cantidad=qty;}else{carritoCompras[i].cantidad+=qty;}
if(carritoCompras[i].cantidad<=0){carritoCompras[i].cantidad=1;}
this.refrescarMostrador();break;}}};Aplicacion.ComprasMostrador.prototype.refrescarMostrador=function()
{if(DEBUG)
console.log("Revisando el estado de la bascula !!!!");if(Aplicacion.ComprasMostrador.bascula.running==false){POS.ajaxToClient({module:"bascula",raw_args:{send_command:'P',read_next:14},success:function(r){Aplicacion.ComprasMostrador.bascula.is_ok=r.success;console.log("Revision de la bascula regreso : "+r.success);if(!r.success){}else{Aplicacion.ComprasMostrador.bascula.running=true;Aplicacion.ComprasMostrador.bascula.check_now();}},failure:function(){Aplicacion.ComprasMostrador.bascula.running=false;Aplicacion.ComprasMostrador.bascula.is_ok=false;}});}
carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;var html="<table border=0  style='font-size: 14px;border: 1px solid #DDD;' >";html+="<tr class='top' style = 'height:200px;'>";html+="<td align='center' colspan = '12'>";html+="       <div align='center' width:100%; height:200px;'>";html+="           <div id = 'led_display' style = 'position:relative; float:left; width:80%; left:10%; height:140px; line-height:140px; background-color:black; color:#00FF00; font-size:50px;'>88888.88</div>";html+="           <div align='center'             style = 'position:relative; float:left; width:90%; left:5%; height:60px; font-size:15px;'>";html+="               <div  style = 'position:relative; float:left; width:20%;'><div style = 'position:relative; width:80%; top:5px; height:50px; line-height:50px; border:solid 1px #8c898c; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px;' onClick=\"Aplicacion.ComprasMostrador.currentInstance.setDisplay('CB')\" id = 'display-bascula'>BASCULA</div></div>";html+="               <div id = 'display-unit'    style = 'position:relative; float:left; width:20%;'><div style = 'position:relative; width:80%; top:5px; height:50px; line-height:50px; border:solid 1px #8c898c; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px;' onClick=\"Aplicacion.ComprasMostrador.currentInstance.setDisplay('C')\">LB/KG</div></div>";html+="               <div id = 'display-zero'    style = 'position:relative; float:left; width:20%;'><div style = 'position:relative; width:80%; top:5px; height:50px; line-height:50px; border:solid 1px #8c898c; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px;' onClick=\"Aplicacion.ComprasMostrador.currentInstance.setDisplay('Z')\">ZERO</div></div>";html+="               <div id = 'display-net-gross' style = 'position:relative; float:left; width:20%;'><div style = 'position:relative; width:80%; top:5px; height:50px; line-height:50px; border:solid 1px #8c898c; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px;' onClick=\"Aplicacion.ComprasMostrador.currentInstance.setDisplay('GN')\">NET/GROSS</div></div>";html+="               <div id = 'display-tare'    style = 'position:relative; float:left; width:20%;'><div style = 'position:relative; width:80%; top:5px; height:50px; line-height:50px; border:solid 1px #8c898c; -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px;' onClick=\"Aplicacion.ComprasMostrador.currentInstance.setDisplay('T')\">TARA</div></div>";html+="           </div>";html+="       </div>";html+="</td>";html+="</tr>";html+="<tr class='top'>";html+="<td align='left'>Descripcion</td>";html+="<td>&nbsp</td>";html+="<td align='center'>&nbsp</td>";html+="<td align='center'>&nbsp</td>";html+="<td align='center'>&nbsp</td>";html+="<td align='center'>Cantidad</td>";html+="<td align='center'>&nbsp</td>";html+="<td align='center'>&nbsp</td>";html+="<td>Descuento</td>";html+="<td align='left' >Total</td>";html+="<td align='left' >Precio</td>";html+="<td align='left' >Sub Total</td>";html+="</tr>";var venta_intersucursal=false;if(carritoCompras.cliente!=null&&carritoCompras.cliente.id_cliente<0){venta_intersucursal=true;if(DEBUG){console.log("venta_ intersucursal activada");}}
var stotal=0;for(var i=0;i<carritoCompras.items.length;i++){var productoI=inventario.findRecord("productoID",carritoCompras.items[i].id_producto,0,false,true,true);switch(productoI.get("medida")){case"pieza":carritoCompras.items[i].cantidad=Math.round(carritoCompras.items[i].cantidad);if(DEBUG){console.log("ROUNDING:",carritoCompras.items[i].cantidad,Math.round(carritoCompras.items[i].cantidad));}
break;default:}
if(parseFloat(productoI.get("existencias"))==0){if(DEBUG){console.log("No hay originales !!");}
carritoCompras.items[i].procesado="true";}
if(parseFloat(productoI.get("existenciasProcesadas"))==0){if(DEBUG){console.log("No hay procesadas !!");}
carritoCompras.items[i].procesado="false";}
if(carritoCompras.items[i].tratamiento!=null){if(carritoCompras.items[i].procesado=="true"){if(DEBUG){console.log("quiero "+carritoCompras.items[i].cantidad+" procesadas y hay "+productoI.get("existenciasProcesadas"));}}else{if(DEBUG){console.log("quiero "+carritoCompras.items[i].cantidad+" originales y hay "+productoI.get("existencias"));}}}else{}
var color=i%2==0?"":"style='background-color:#f7f7f7;'";color="";html+="<tr "+color+">";html+="<td style='width: 18.7%;' ><b>"+carritoCompras.items[i].id_producto+"</b> &nbsp;"+carritoCompras.items[i].descripcion+"</td>";html+="<td style='width: 12%;' ><div id='ComprasMostrador-carritoTratamiento"+carritoCompras.items[i].idUnique+"'></div></td>";html+="<td  style = 'background :none' align='right' style='width:4%;'> <span class='boton'  onClick=\"Aplicacion.ComprasMostrador.currentInstance.quitarDelcarritoCompras('"+carritoCompras.items[i].idUnique+"')\"><img src='../media/icons/close_16.png'></span></td>";html+="<td style = 'background :none'  align='center' style='width:4%;'> <span class='boton'  onClick=\"Aplicacion.ComprasMostrador.currentInstance.pesarProducto('"+carritoCompras.items[i].idUnique+"')\"><img width = 16px; height:16px;  valign = 'center' src='../media/icons/basket_search_32.png'></span></td>";html+="<td  style = 'background :none' align='center'  style='width: 8.1%;'> <span class='boton' onClick=\"Aplicacion.ComprasMostrador.currentInstance.carritoComprasCambiarCantidad('"+carritoCompras.items[i].idUnique+"', -1, false)\"><img src='../media/icons/arrow_down_16.png'></span></td>";var escala_de_compra=null;if(productoI.get("precioPorAgrupacion")){escala_de_compra=productoI.get("agrupacion");}else{switch(productoI.get("medida")){case"kilogramo":escala_de_compra="Kgs";break;case"pieza":escala_de_compra="Pzas";break;case"litro":escala_de_compra="Lts.";break;}}
html+="<td  align='center'  style='width: 7.2%;' ><div id='ComprasMostrador-carritoCantidad"+carritoCompras.items[i].idUnique+"'></div></td><td>"+escala_de_compra+"</td>";html+="<td  align='center'  style='width: 8.1%;'> <span class='boton' onClick=\"Aplicacion.ComprasMostrador.currentInstance.carritoComprasCambiarCantidad('"+carritoCompras.items[i].idUnique+"', 1, false)\"><img src='../media/icons/arrow_up_16.png'></span></td>";html+="<td style='width: 8%;' ><div id='ComprasMostrador-carritoDescuento"+carritoCompras.items[i].idUnique+"'></div></td>";html+="<td  align='center'  style='width: 6.3%;' ><div >"+(carritoCompras.items[i].cantidad-carritoCompras.items[i].descuento)+" "+escala_de_compra+"</div></td>";html+="<td style='width: 10.4%;'> <div  id='ComprasMostrador-carritoPrecio"+carritoCompras.items[i].idUnique+"'></div></td>";html+="<td  style='width: 11.3%;'>"+POS.currencyFormat((carritoCompras.items[i].cantidad-carritoCompras.items[i].descuento)*carritoCompras.items[i].precio)+"</td>";html+="</tr>";stotal+=((carritoCompras.items[i].cantidad-carritoCompras.items[i].descuento)*carritoCompras.items[i].precio);}
var style="";style+="font-weight: bold;";style+="color: black;";if(carritoCompras.items.length>0){html+="<tr class='last' style='"+style+"' align=right>";html+=" <td colspan=9></td>";html+=" <td style='text-align:right'>Total</td>";html+=" <td style='text-align:left'>"+POS.currencyFormat(stotal)+"</td>";html+="</tr>";}
html+="</table>";Ext.getCmp("ComprasMostradorHtmlPanel").update(html);if(carritoCompras.items.length>0){Ext.getCmp("ComprasMostrador-mostradorVender").show(Ext.anims.slide);}else{Ext.getCmp("ComprasMostrador-mostradorVender").hide(Ext.anims.slide);}
for(i=0;i<carritoCompras.items.length;i++){if(Ext.get("ComprasMostrador-carritoCantidad"+carritoCompras.items[i].productoID+"Text")){continue;}
a=new Ext.form.Text({renderTo:"ComprasMostrador-carritoCantidad"+carritoCompras.items[i].idUnique,id:"ComprasMostrador-carritoCantidad"+carritoCompras.items[i].idUnique+"Text",value:(carritoCompras.items[i].cantidad==null||carritoCompras.items[i].cantidad=="null")?"":carritoCompras.items[i].cantidad,prodID:carritoCompras.items[i].id_producto,idUnique:carritoCompras.items[i].idUnique,fieldCls:'ComprasMostrador-input',style:{textAlign:'center',width:'100%'},placeHolder:"",listeners:{'focus':function(){this.setValue("");kconf={type:'num',submitText:'Aceptar',callback:function(campo){for(var i=0;i<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;i++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==campo.idUnique){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].cantidad=parseFloat(campo.getValue());break;}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});b=new Ext.form.Text({renderTo:"ComprasMostrador-carritoPrecio"+carritoCompras.items[i].idUnique,id:"ComprasMostrador-carritoPrecio"+carritoCompras.items[i].idUnique+"Text",value:POS.currencyFormat(carritoCompras.items[i].precio),prodID:carritoCompras.items[i].id_producto,idUnique:carritoCompras.items[i].idUnique,placeHolder:"Precio de Venta",style:{width:'100%'},listeners:{'focus':function(a){this.setValue("");kconf={type:'num',submitText:'Cambiar',callback:function(campo){for(var i=0;i<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;i++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==campo.idUnique){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=="true"){precioVenta=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioVentaProcesado;}else{precioVenta=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioVenta;}
if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=="true"){precioVentaIntersucursal=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioIntersucursalProcesado;}else{precioVentaIntersucursal=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioIntersucursal;}
if(!(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente!=null&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.venta_preferencial.cliente!=null&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente.id_cliente==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.venta_preferencial.cliente.id_cliente))
{if(parseFloat(campo.getValue())<parseFloat(precioVenta)){Ext.Msg.alert("Mostrador","No puede bajar un precio por debajo del preestablecido.");Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=precioVenta;break;}}
if(venta_intersucursal)
{if(parseFloat(campo.getValue())!=parseFloat(precioVentaIntersucursal))
{Ext.Msg.alert("Mostrador","No puede modificar el precio de un producto en una venta intersucursal.");Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=precioVentaIntersucursal;break;}}
var error=false;for(var j=0;j<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;j++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].idUnique){continue;}
if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].id_producto==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].id_producto&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].procesado&&parseFloat(campo.getValue())!=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].precio){descripcion=(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=="true")?"Limpia":"Original";Ext.Msg.alert("Alerta","Existen 2 procuctos "+Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].descripcion+" "+descripcion+" con diferente precio.");Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=parseFloat(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].precio)
error=true;break;}}
if(error){break;}
Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=parseFloat(campo.getValue());break;}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});if(carritoCompras.items[i].tratamiento!=null){var habilitar_boton_tratamiento=true;var productoI=inventario.findRecord("productoID",carritoCompras.items[i].id_producto,0,false,true,true);if(parseFloat(productoI.get("existencias"))==0){if(DEBUG){console.log("no hay originales !!");}
carritoCompras.items[i].procesado="true";habilitar_boton_tratamiento=false;}
if(parseFloat(productoI.get("existenciasProcesadas"))==0){if(DEBUG){console.log("no hay procesadas !!");}
carritoCompras.items[i].procesado="false";habilitar_boton_tratamiento=false;}
c=new Ext.form.Select({renderTo:"ComprasMostrador-carritoTratamiento"+carritoCompras.items[i].idUnique,id:"ComprasMostrador-carritoTratamiento"+carritoCompras.items[i].idUnique+"Select",idUnique:carritoCompras.items[i].idUnique,disabled:!habilitar_boton_tratamiento,value:carritoCompras.items[i].procesado,style:{width:'100%'},options:[{text:"Limpia",value:"true"},{text:"Original",value:"false"}],listeners:{"change":function(){if(DEBUG){console.log("OK, cambie de tipo de proceso a ...",this.value);}
for(var i=0;i<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;i++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==this.idUnique){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=this.value;var found=null;if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=="true"){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].descuento="0";found=false;for(var j=0;j<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;j++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].idUnique){continue;}
if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].id_producto==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].id_producto&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].procesado){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=parseFloat(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].precio);found=true;break;}}
if(found){break;}else{if(venta_intersucursal){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioIntersucursalProcesado;}else{Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioVentaProcesado;}}}else{found=false;for(var j=0;j<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;j++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].idUnique){continue;}
if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].id_producto==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].id_producto&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].procesado){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=parseFloat(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].precio);Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].descuento=parseFloat(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].descuento);found=true;break;}}
if(found){break;}else{if(venta_intersucursal){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioIntersucursal;}else{Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precio=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].precioVenta;}}}
if(DEBUG){console.log("El producto "+this.idUnique+" esta  procesado ?"+Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado);}}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();}}});}
d=new Ext.form.Text({renderTo:"ComprasMostrador-carritoDescuento"+carritoCompras.items[i].idUnique,id:"ComprasMostrador-carritoDescuento"+carritoCompras.items[i].idUnique+"Text",value:carritoCompras.items[i].descuento,prodID:carritoCompras.items[i].id_producto,idUnique:carritoCompras.items[i].idUnique,style:{width:'100%'},listeners:{'focus':function(a){this.setValue("");kconf={type:'num',submitText:'Cambiar',callback:function(campo){for(var i=0;i<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;i++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==campo.idUnique){var error=false;for(var j=0;j<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;j++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].idUnique){continue;}
if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].id_producto==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].id_producto&&Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado==Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].procesado&&parseFloat(campo.getValue())!=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].descuento){descripcion=(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].procesado=="true")?"Limpia":"Original";Ext.Msg.alert("Alerta","Existen 2 procuctos "+Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].descripcion+" "+descripcion+" con diferente descuento.");Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].descuento=parseFloat(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[j].descuento)
error=true;break;}}
if(error){break;}
var value=campo.getValue();if(!isNaN(value)&&value>=0&&value<carritoCompras.items[i].cantidad){carritoCompras.items[i].descuento=value;}else{campo.setValue("0");carritoCompras.items[i].descuento="0";}
break;}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();}};POS.Keyboard.Keyboard(this,kconf);}}});}};Aplicacion.ComprasMostrador.prototype.agregarProducto=function()
{val=Aplicacion.ComprasMostrador.currentInstance.mostradorPanel.getDockedComponent(0).getComponent(0).getValue();Aplicacion.ComprasMostrador.currentInstance.mostradorPanel.getDockedComponent(0).getComponent(0).setValue("");Aplicacion.ComprasMostrador.currentInstance.agregarProductoPorID(val);};Aplicacion.ComprasMostrador.prototype.agregarProductoPorID=function(id)
{inventario=Aplicacion.Inventario.currentInstance.inventarioListaStore;if(DEBUG){console.log("buscando el producto"+id);console.log("Aplicacion.Inventario.currentInstance.inventarioListaStore es : ",Aplicacion.Inventario.currentInstance.inventarioListaStore);}
res=inventario.findRecord("productoID",id,0,false,true,true);if(res===null){Ext.Msg.alert("Mostrador","Este producto no existe");return;}
if(DEBUG){console.log("Agregando el producto "+id+" al carritoCompras.",res);}
for(var a=0,found=false,incidencias=0;a<this.carritoCompras.items.length;a++)
{if(this.carritoCompras.items[a].id_producto==id)
{incidencias++;if(this.carritoCompras.items[a].tratamiento==""){found=true;this.carritoCompras.items[a].cantidad++;break;}
if(incidencias>1){Ext.Msg.alert("Mostrador","El producto "+res.data.descripcion+" ya existe en el carritoCompras.");found=true;break;}}}
var venta_intersucursal=false;if(carritoCompras.cliente!=null&&carritoCompras.cliente.id_cliente<0){venta_intersucursal=true;if(DEBUG){console.log("venta intesucursal activadan al insertar el producto");}}
if(!found)
{this.carritoCompras.items.push({descripcion:res.data.descripcion,existencias:res.data.existencias,existencias_procesadas:res.data.existenciasProcesadas,tratamiento:res.data.tratamiento,precioVenta:res.data.precioVenta,precioVentaProcesado:res.data.precioVentaProcesado,precioIntersucursal:res.data.precioIntersucursal,precioIntersucursalProcesado:res.data.precioIntersucursalProcesado,precio:venta_intersucursal?res.data.tratamiento!=null?res.data.precioIntersucursalProcesado:res.data.precioIntersucursalProcesado:res.data.tratamiento!=null?res.data.precioVentaProcesado:res.data.precioVenta,id_producto:res.data.productoID,escala:res.data.medida,procesado:res.data.tratamiento!=null?"true":"false",cantidad:1,idUnique:res.data.productoID+"_"+Aplicacion.ComprasMostrador.currentInstance.uniqueIndex,descuento:"0",input_box_rendered:false});Aplicacion.ComprasMostrador.currentInstance.uniqueIndex++;}
this.refrescarMostrador();};Aplicacion.ComprasMostrador.prototype.uniqueIndex=0;Aplicacion.ComprasMostrador.prototype.quitarDelcarritoCompras=function(id)
{if(DEBUG){console.log("Removiendo del carritoCompras.");}
carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;for(var i=carritoCompras.items.length-1;i>=0;i--){if(carritoCompras.items[i].idUnique==id){carritoCompras.items.splice(i,1);break;}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();};Aplicacion.ComprasMostrador.prototype.mostradorPanel=null;Aplicacion.ComprasMostrador.prototype.mostradorPanelCreator=function(){var productos=[{xtype:'textfield',placeHolder:"Agregar Producto",listeners:{'focus':function(){kconf={type:'num',submitText:'Agregar',callback:Aplicacion.ComprasMostrador.currentInstance.agregarProducto};POS.Keyboard.Keyboard(this,kconf);}}},{xtype:"button",text:"Buscar",handler:function(){sink.Main.ui.setActiveItem(Aplicacion.Inventario.currentInstance.listaInventarioPanel,'fade');}}];var venta=[{text:'Cancelar Compra',ui:'action',handler:this.cancelarCompra},{xtype:'segmentedbutton',id:'ComprasMostrador-tipoCliente',allowDepress:false,items:[{text:'Caja Comun',pressed:true,handler:this.setCajaComun},{text:'Cliente',handler:this.buscarClienteFormShow,badgeText:""}]},{id:'ComprasMostrador-mostradorVender',hidden:true,text:'Comprar',ui:'forward',handler:function(){Aplicacion.ComprasMostrador.currentInstance.comprar();}}];productos.push({xtype:'spacer'});var dockedItems=[new Ext.Toolbar({ui:'light',dock:'bottom',items:productos.concat(venta)})];this.mostradorPanel=new Ext.Panel({listeners:{"show":this.refrescarMostrador,"hide":function(){if(DEBUG)
console.log("Estoy ocultando el mostrador de compras ! Deteniendo la bascula");Aplicacion.ComprasMostrador.bascula.running=false;}},floating:false,ui:"dark",modal:false,cls:"Tabla",items:[{id:'ComprasMostradorHtmlPanel',html:null}],scroll:'none',dockedItems:dockedItems});};Aplicacion.ComprasMostrador.prototype.buscarClienteForm=null;Aplicacion.ComprasMostrador.prototype.clienteSeleccionado=function(cliente)
{if(DEBUG){console.log("cliente seleccionado",cliente);}
this.buscarClienteFormShow();Ext.getCmp("ComprasMostrador-tipoCliente").getComponent(1).setBadge(cliente.razon_social);Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente=cliente;if(cliente.id_cliente<0)
{if(DEBUG){console.log("Seleccionamos una sucursal como cliente : restaurando precios intersucursal");}
Aplicacion.ComprasMostrador.currentInstance.restaurarPreciosIntersucursal();}
else
{if(DEBUG){console.log("Seleccionamos un cliente normal : restaurando precios originales");}
Aplicacion.ComprasMostrador.currentInstance.restaurarPreciosOriginales();}};Aplicacion.ComprasMostrador.prototype.clientePreferencialSeleccionado=function(cliente)
{if(DEBUG){console.log("cliente preferencial seleccionado",cliente);}
Ext.getCmp("ComprasMostrador-tipoCliente").getComponent(1).setBadge(cliente.razon_social);Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente=cliente;Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador()};Aplicacion.ComprasMostrador.prototype.setCajaComun=function()
{if(Ext.getCmp('ComprasMostrador-tipoCliente').getPressed()){Ext.getCmp('ComprasMostrador-tipoCliente').setPressed(Ext.getCmp('ComprasMostrador-tipoCliente').getPressed());}
Ext.getCmp("ComprasMostrador-tipoCliente").getComponent(1).setBadge();Ext.getCmp('ComprasMostrador-tipoCliente').setPressed(0);Aplicacion.ComprasMostrador.currentInstance.carritoCompras.tipo_venta="contado";Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente=null;};Aplicacion.ComprasMostrador.prototype.buscarClienteFormCreator=function()
{var dockedCancelar={xtype:'button',text:'Cancelar',handler:function(){Aplicacion.ComprasMostrador.currentInstance.setCajaComun();Aplicacion.ComprasMostrador.currentInstance.buscarClienteFormShow();}};var dockedItems={xtype:'toolbar',dock:'bottom',items:[dockedCancelar,{xtype:'spacer'}]};var formBase={autoRender:true,style:{zIndex:'10000 !important'},listeners:{'show':function(){if(!Aplicacion.ComprasMostrador.currentInstance.buscarClienteForm.getComponent(0).getStore())
{Aplicacion.ComprasMostrador.currentInstance.buscarClienteForm.getComponent(0).bindStore(Aplicacion.Clientes.currentInstance.listaDeClientesStore);}}},floating:true,modal:true,centered:true,hideOnMaskTap:false,height:585,width:680,items:[{width:'100%',height:'100%',xtype:'list',store:Aplicacion.Clientes?Aplicacion.Clientes.currentInstance.listaDeClientesStore:null,itemTpl:'<div class="listaDeClientesCliente"><strong>{razon_social}</strong> {rfc}</div>',grouped:true,indexBar:true,listeners:{"selectionchange":function(view,nodos,c){if(nodos.length>0){Aplicacion.ComprasMostrador.currentInstance.clienteSeleccionado(nodos[0].data);}
view.deselectAll();}}}],dockedItems:dockedItems};if(DEBUG){console.log("creando la forma de buscar clientes");}
this.buscarClienteForm=new Ext.Panel(formBase);this.buscarClienteForm.setVisible(false);};Aplicacion.ComprasMostrador.prototype.buscarClienteFormShow=function()
{if(Aplicacion.ComprasMostrador.currentInstance.buscarClienteForm){Aplicacion.ComprasMostrador.currentInstance.buscarClienteForm.setVisible(!Aplicacion.ComprasMostrador.currentInstance.buscarClienteForm.isVisible());}else{Aplicacion.ComprasMostrador.currentInstance.buscarClienteFormCreator();Aplicacion.ComprasMostrador.currentInstance.buscarClienteFormShow();}};Aplicacion.ComprasMostrador.prototype.finishedPanel=null;Aplicacion.ComprasMostrador.prototype.finishedPanelShow=function(compra_id)
{this.finishedPanelUpdater(compra_id);sink.Main.ui.setActiveItem(Aplicacion.ComprasMostrador.currentInstance.finishedPanel,'fade');};Aplicacion.ComprasMostrador.prototype.finishedPanelUpdater=function(compra_id)
{carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;carritoCompras.sucursal=POS.infoSucursal;carritoCompras.descuento=parseFloat(carritoCompras.descuento);carritoCompras.ticket="venta_cliente";carritoCompras.leyendasTicket=POS.leyendasTicket;if(DEBUG){console.warn("Voy a imprimir el ticket id :"+compra_id);console.warn("Los demas datos son",Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items);}
ticket=POS.leyendasTicket.cabeceraTicket+"\n";ticket+=POS.leyendasTicket.direccion+"\n";ticket+="======== COMPRA  "+compra_id+" ==================="+"\n\n";var subtotal=0;var lista=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items
ticket+=POS.fillWithSpaces("PRODUCTO",11,false);ticket+=" ";ticket+=POS.fillWithSpaces("CANT",5,false);ticket+=" ";ticket+=POS.fillWithSpaces("PRECIO",6,false);ticket+=" ";ticket+=POS.fillWithSpaces("IMPORTE",10,false)+"\n";ticket+="-------------------------------------------------------------------------"+"\n";for(var i=lista.length-1;i>=0;i--)
{var item=lista[i];subtotal+=parseFloat(item.cantidad)*parseFloat(item.precio);var prods=Aplicacion.Inventario.currentInstance.Inventario.productos;var p=0,found=false;for(p=0;p<prods.length;p++)
{if(parseInt(prods[p].data.productoID)==parseInt(item.id_producto))
{found=true;break;}};if(item.cantidad!=0)
{var qty=item.cantidad;if(found&&prods[p].data.precioPorAgrupacion)
{qty/=parseFloat(prods[p].data.agrupacionTam);}
ticket+=POS.fillWithSpaces(item.descripcion,11,false);ticket+=" ";ticket+=POS.fillWithSpaces(qty,5,false);ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(item.precio),6,false);ticket+=" ";ticket+=POS.fillWithSpaces(POS.currencyFormat(parseFloat(qty)*parseFloat(item.precio)),10,false)+"\n";}};ticket+="-------------------------------------------------------------------------"+"\n";ticket+="               Subtotal  "+POS.currencyFormat(subtotal)+"\n";ticket+="               -------------------"+"\n";ticket+="               Total     "+POS.currencyFormat(subtotal)+"\n";ticket+="\n";ticket+=POS.leyendasTicket.contacto;POS.ajaxToClient({module:"Impresiones",args:{free_text:ticket},success:function(r){if(DEBUG){console.log("ticket printing responded",r);}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});html="";html+="<table class='Mostrador-ThankYou'>";html+=" <tr>";html+="  <td ><img width = 200px height = 200px src='../media/Receipt128.png'></td>";html+="  <td></td>";html+=" </tr>";if(carritoCompras.tipo_venta!="credito"){html+=" <tr>";html+="  <td>Gracias por su compra</td>";html+="  <td></td>";html+=" </tr>";}
html+="</table>";this.finishedPanel.update(html);Ext.getCmp("ComprasMostrador-mostradorVender").hide(Ext.anims.slide);action="sink.Main.ui.setActiveItem( Aplicacion.ComprasMostrador.currentInstance.mostradorPanel , 'fade');";setTimeout(action,4000);};Aplicacion.ComprasMostrador.prototype.finishedPanelCreator=function()
{this.finishedPanel=new Ext.Panel({html:""});};Aplicacion.ComprasMostrador.prototype.doCompra=function()
{carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;if(carritoCompras.tipo_venta=='contado'){if(DEBUG){console.log("revisando compra a contado...");}
pagado=Ext.getCmp("ComprasMostrador-doNuevaVentaImporte").getValue();if((pagado.length===0)||(parseFloat(pagado)<parseFloat(carritoCompras.total))){Ext.Msg.alert("Mostrador","Verifique al cantidad del importe.");return;}
this.carritoCompras.pagado=parseFloat(pagado);this.comprar();}else{if(DEBUG){console.log("revisando compra a credito...");}
this.comprar();}};Aplicacion.ComprasMostrador.thisPosSaleId=0;Aplicacion.ComprasMostrador.prototype.offlineVender=function()
{if(DEBUG){console.warn("-------- Venta offline !!! ---------");console.log("Aplicacion.ComprasMostrador.thisPosSaleId="+Aplicacion.ComprasMostrador.thisPosSaleId);}
var carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;var this_sale=new Ventas({id_venta:Aplicacion.ComprasMostrador.thisPosSaleId,id_venta_equipo:Aplicacion.ComprasMostrador.thisPosSaleId,id_equipo:1,id_cliente:carritoCompras.cliente,tipo_venta:carritoCompras.tipo_venta,tipo_pago:carritoCompras.tipo_pago,fecha:null,subtotal:carritoCompras.subtotal,iva:carritoCompras.iva,descuento:0,total:carritoCompras.total,id_sucursal:null,id_usuario:null,pagado:carritoCompras.pagado,cancelada:null,ip:null,liquidada:null});this_sale.save(function(saved_sale){if(DEBUG)console.log("Back from saving offline sale sale !",saved_sale);var detalles=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items,l=Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;if(DEBUG)console.log("Ahora intentare guardar los "+l+" detalles.");for(var d=0,td=null;d<detalles.length;d++){if(DEBUG)console.log("guardando detalle...");td=new DetalleVenta({id_venta:saved_sale.getIdVenta(),id_producto:detalles[d].id_producto,cantidad:detalles[d].cantidad,cantidad_procesada:detalles[d].cantidad,precio:detalles[d].precioVenta,precio_procesada:detalles[d].precioVentaProcesado,descuento:detalles[d].descuento});td.save(function(){if(DEBUG){console.log("termine de guardar el detalle de venta");}});Aplicacion.ComprasMostrador.currentInstance.cancelarCompra();}});Aplicacion.ComprasMostrador.currentInstance.finishedPanelShow();}
Aplicacion.ComprasMostrador.prototype.comprar=function(){if(DEBUG){console.log(" ----- Enviando compra :",Aplicacion.ComprasMostrador.currentInstance.carritoCompras," ----------");}
Aplicacion.ComprasMostrador.thisPosSaleId++;if(POS.A.failure){return Aplicacion.ComprasMostrador.currentInstance.offlineVender();}
Ext.Ajax.request({url:'../proxy.php',scope:this,params:{action:1006,data:Ext.util.JSON.encode({id_cliente:Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente,tipo_compra:Aplicacion.ComprasMostrador.currentInstance.carritoCompras.tipo_venta,tipo_pago:Aplicacion.ComprasMostrador.currentInstance.carritoCompras.tipo_pago,productos:Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items})},success:function(response,opts){var compra=null;try{compra=Ext.util.JSON.decode(response.responseText);}catch(e){POS.error(response,e);Aplicacion.ComprasMostrador.currentInstance.offlineVender();return;}
if(!compra.success){if(DEBUG){console.log("resultado de la compra sin exito ",compra);}
POS.error(compra);Aplicacion.ComprasMostrador.currentInstance.offlineVender();return;}
if(DEBUG){console.log("resultado de la compra exitosa ",compra);}
carritoCompras=Aplicacion.ComprasMostrador.currentInstance.carritoCompras;if(carritoCompras.cliente!=null&&carritoCompras.venta_preferencial.cliente!=null&&carritoCompras.cliente.id_cliente==carritoCompras.venta_preferencial.cliente.id_cliente)
{Aplicacion.Autorizaciones.currentInstance.finalizarAutorizacionVentaPreferencial();}
carritoCompras.id_venta=compra.id_compra;if(DEBUG){console.warn("Voy a imprimir el ticket id :"+compra.id_compra);console.warn("Los demas datos son",Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items);}
Aplicacion.ComprasMostrador.currentInstance.carritoCompras.empleado=compra.empleado;Aplicacion.Inventario.currentInstance.cargarInventario();if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.cliente!==null)
{Aplicacion.Clientes.currentInstance.listaDeClientesLoad();if(DEBUG)console.log("Recargando la lista de clientes");}
Aplicacion.ComprasMostrador.currentInstance.finishedPanelShow(compra.id_compra);Aplicacion.ComprasMostrador.currentInstance.cancelarCompra();},failure:function(response){Ext.Msg.alert("Error","Error en la compra");POS.error(response);return offlineVender();}});};Aplicacion.ComprasMostrador.prototype.pesarProducto=function(id_unique){POS.ajaxToClient({module:"bascula",raw_args:{send_command:'P',read_next:8},success:function(r){if(r.success==true){var trimmed=r.reading;trimmed=trimmed.replace(/^\s+|\s+$/g,"");trimmed=trimmed.replace("K","");for(var i=0;i<Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items.length;i++){if(Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].idUnique==id_unique){Aplicacion.ComprasMostrador.currentInstance.carritoCompras.items[i].cantidad=parseFloat((trimmed==null||trimmed=="null")?0:trimmed);break;}}
Aplicacion.ComprasMostrador.currentInstance.refrescarMostrador();}else{Ext.Msg.alert("Alerta","Error al acceder a la bascula");}},failure:function(){if(DEBUG){console.warn("client not found !!!",r);}}});};Aplicacion.ComprasMostrador.NET_GROSS=true;Aplicacion.ComprasMostrador.BASCULA_ACTIVA=0;Aplicacion.ComprasMostrador.prototype.setDisplay=function(command_to_send){if(command_to_send=="CB")
{return Aplicacion.ComprasMostrador.bascula.cambiar_bascula();}
if(command_to_send=="NG"){if(Aplicacion.ComprasMostrador.NET_GROSS){command_to_send="G";}else{command_to_send="N";}
Aplicacion.ComprasMostrador.NET_GROSS=!Aplicacion.ComprasMostrador.NET_GROSS;}
Aplicacion.ComprasMostrador.bascula.enviar_comando(command_to_send);};if(DEBUG)
console.warn("POS_COMPRA_A_CLIENTES esta activado !!!")
POS.Apps.push(new Aplicacion.ComprasMostrador());
